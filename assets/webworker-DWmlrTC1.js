var Eo=Object.defineProperty;var Po=(ge,q,de)=>q in ge?Eo(ge,q,{enumerable:!0,configurable:!0,writable:!0,value:de}):ge[q]=de;var Oe=(ge,q,de)=>(Po(ge,typeof q!="symbol"?q+"":q,de),de);(function(){"use strict";const ge="__run";class q{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new q({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}}function de(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var Cn=function(n,e){if(typeof n!="string")throw new TypeError("Expected a string");return e=typeof e>"u"?"_":e,n.replace(/([a-z\d])([A-Z])/g,"$1"+e+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+e+"$2").toLowerCase()},In=de(Cn),kr={exports:{}};const Rn=/[\p{Lu}]/u,Nn=/[\p{Ll}]/u,Tr=/^[\p{Lu}](?![\p{Lu}])/gu,Or=/([\p{Alpha}\p{N}_]|$)/u,Er=/[_.\- ]+/,jn=new RegExp("^"+Er.source),Pr=new RegExp(Er.source+Or.source,"gu"),Sr=new RegExp("\\d+"+Or.source,"gu"),$n=(n,e,t)=>{let r=!1,a=!1,s=!1;for(let i=0;i<n.length;i++){const o=n[i];r&&Rn.test(o)?(n=n.slice(0,i)+"-"+n.slice(i),r=!1,s=a,a=!0,i++):a&&s&&Nn.test(o)?(n=n.slice(0,i-1)+"-"+n.slice(i-1),s=a,a=!1,r=!0):(r=e(o)===o&&t(o)!==o,s=a,a=t(o)===o&&e(o)!==o)}return n},Ln=(n,e)=>(Tr.lastIndex=0,n.replace(Tr,t=>e(t))),Dn=(n,e)=>(Pr.lastIndex=0,Sr.lastIndex=0,n.replace(Pr,(t,r)=>e(r)).replace(Sr,t=>e(t))),Ar=(n,e)=>{if(!(typeof n=="string"||Array.isArray(n)))throw new TypeError("Expected the input to be `string | string[]`");if(e={pascalCase:!1,preserveConsecutiveUppercase:!1,...e},Array.isArray(n)?n=n.map(s=>s.trim()).filter(s=>s.length).join("-"):n=n.trim(),n.length===0)return"";const t=e.locale===!1?s=>s.toLowerCase():s=>s.toLocaleLowerCase(e.locale),r=e.locale===!1?s=>s.toUpperCase():s=>s.toLocaleUpperCase(e.locale);return n.length===1?e.pascalCase?r(n):t(n):(n!==t(n)&&(n=$n(n,t,r)),n=n.replace(jn,""),e.preserveConsecutiveUppercase?n=Ln(n,t):n=t(n),e.pascalCase&&(n=r(n.charAt(0))+n.slice(1)),Dn(n,r))};kr.exports=Ar,kr.exports.default=Ar;function Mn(n,e){return(e==null?void 0:e[n])||In(n)}function Un(n,e,t){const r={};for(const a in n)Object.hasOwn(n,a)&&(r[e(a,t)]=n[a]);return r}function Cr(n){return Array.isArray(n)?[...n]:{...n}}function Zn(n,e){const t=Cr(n);for(const[r,a]of Object.entries(e)){const[s,...i]=r.split(".").reverse();let o=t;for(const u of i.reverse()){if(o[u]===void 0)break;o[u]=Cr(o[u]),o=o[u]}o[s]!==void 0&&(o[s]={lc:1,type:"secret",id:[a]})}return t}function Ir(n){const e=Object.getPrototypeOf(n);return typeof n.lc_name=="function"&&(typeof e.lc_name!="function"||n.lc_name()!==e.lc_name())?n.lc_name():n.name}class Ee{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,Ir(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof Ee||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},t={},r=Object.keys(this.lc_kwargs).reduce((a,s)=>(a[s]=s in this?this[s]:this.lc_kwargs[s],a),{});for(let a=Object.getPrototypeOf(this);a;a=Object.getPrototypeOf(a))Object.assign(e,Reflect.get(a,"lc_aliases",this)),Object.assign(t,Reflect.get(a,"lc_secrets",this)),Object.assign(r,Reflect.get(a,"lc_attributes",this));return Object.keys(t).forEach(a=>{let s=this,i=r;const[o,...u]=a.split(".").reverse();for(const c of u.reverse()){if(!(c in s)||s[c]===void 0)return;(!(c in i)||i[c]===void 0)&&(typeof s[c]=="object"&&s[c]!=null?i[c]={}:Array.isArray(s[c])&&(i[c]=[])),s=s[c],i=i[c]}o in s&&s[o]!==void 0&&(i[o]=i[o]||s[o])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:Un(Object.keys(t).length?Zn(r,t):r,Mn,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}function qe(n,e){return typeof n=="string"?typeof e=="string"?n+e:[{type:"text",text:n},...e]:Array.isArray(e)?[...n,...e]:[...n,{type:"text",text:e}]}class Je extends Ee{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return typeof this.content=="string"?this.content:""}constructor(e,t){typeof e=="string"&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}toChunk(){const e=this._getType();if(e==="human")return new Ht({...this});if(e==="ai")return new yt({...this});if(e==="system")return new Vt({...this});if(e==="function")return new Gt({...this});if(qt.isInstance(this))return new Jt({...this});throw new Error("Unknown message type.")}}function Rr(n){return Array.isArray(n)&&n.every(e=>typeof e.index=="number")}function Y(n,e){var r,a;const t={...n};for(const[s,i]of Object.entries(e))if(t[s]==null)t[s]=i;else{if(i==null)continue;if(typeof t[s]!=typeof i||Array.isArray(t[s])!==Array.isArray(i))throw new Error(`field[${s}] already exists in the message chunk, but with a different type.`);if(typeof t[s]=="string")t[s]=t[s]+i;else if(!Array.isArray(t[s])&&typeof t[s]=="object")t[s]=Y(t[s],i);else if(s==="tool_calls"&&Rr(t[s])&&Rr(i))for(const o of i)((r=t[s])==null?void 0:r[o.index])!==void 0?t[s]=(a=t[s])==null?void 0:a.map((u,c)=>c!==o.index?u:{...u,...o,function:{name:o.function.name??u.function.name,arguments:(u.function.arguments??"")+(o.function.arguments??"")}}):t[s][o.index]=o;else if(Array.isArray(t[s]))t[s]=t[s].concat(i);else{if(t[s]===i)continue;console.warn(`field[${s}] already exists in this message chunk and value has unsupported type.`)}}return t}class We extends Je{}class zt extends Je{static lc_name(){return"HumanMessage"}_getType(){return"human"}}class Ht extends We{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}concat(e){return new Ht({content:qe(this.content,e.content),additional_kwargs:Y(this.additional_kwargs,e.additional_kwargs),response_metadata:Y(this.response_metadata,e.response_metadata)})}}class Nr extends Je{static lc_name(){return"AIMessage"}_getType(){return"ai"}}class yt extends We{static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}concat(e){return new yt({content:qe(this.content,e.content),additional_kwargs:Y(this.additional_kwargs,e.additional_kwargs),response_metadata:Y(this.response_metadata,e.response_metadata)})}}class Bn extends Je{static lc_name(){return"SystemMessage"}_getType(){return"system"}}class Vt extends We{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}concat(e){return new Vt({content:qe(this.content,e.content),additional_kwargs:Y(this.additional_kwargs,e.additional_kwargs),response_metadata:Y(this.response_metadata,e.response_metadata)})}}class Gt extends We{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){return new Gt({content:qe(this.content,e.content),additional_kwargs:Y(this.additional_kwargs,e.additional_kwargs),response_metadata:Y(this.response_metadata,e.response_metadata),name:this.name??""})}}class qt extends Je{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return qt}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return e._getType()==="generic"}}function Fn(n){return typeof(n==null?void 0:n._getType)=="function"}function zn(n){if(typeof n=="string")return new zt(n);if(Fn(n))return n;const[e,t]=n;if(e==="human"||e==="user")return new zt({content:t});if(e==="ai"||e==="assistant")return new Nr({content:t});if(e==="system")return new Bn({content:t});throw new Error("Unable to coerce message from array: only human, AI, or system message coercion is currently supported.")}class Jt extends We{static lc_name(){return"ChatMessageChunk"}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){return new Jt({content:qe(this.content,e.content),additional_kwargs:Y(this.additional_kwargs,e.additional_kwargs),response_metadata:Y(this.response_metadata,e.response_metadata),role:this.role})}}function Wt(n,e="Human",t="AI"){const r=[];for(const a of n){let s;if(a._getType()==="human")s=e;else if(a._getType()==="ai")s=t;else if(a._getType()==="system")s="System";else if(a._getType()==="function")s="Function";else if(a._getType()==="tool")s="Tool";else if(a._getType()==="generic")s=a.role;else throw new Error(`Got unsupported message type: ${a._getType()}`);const i=a.name?`${a.name}, `:"";r.push(`${s}: ${i}${a.content}`)}return r.join(`
`)}let gt;const Hn=new Uint8Array(16);function Vn(){if(!gt&&(gt=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!gt))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return gt(Hn)}var Gn=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function jr(n){return typeof n=="string"&&Gn.test(n)}const D=[];for(let n=0;n<256;++n)D.push((n+256).toString(16).slice(1));function qn(n,e=0){return D[n[e+0]]+D[n[e+1]]+D[n[e+2]]+D[n[e+3]]+"-"+D[n[e+4]]+D[n[e+5]]+"-"+D[n[e+6]]+D[n[e+7]]+"-"+D[n[e+8]]+D[n[e+9]]+"-"+D[n[e+10]]+D[n[e+11]]+D[n[e+12]]+D[n[e+13]]+D[n[e+14]]+D[n[e+15]]}var $r={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function ie(n,e,t){if($r.randomUUID&&!e&&!n)return $r.randomUUID();n=n||{};const r=n.random||(n.rng||Vn)();if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,e){t=t||0;for(let a=0;a<16;++a)e[t+a]=r[a];return e}return qn(r)}var Kt={};const Jn=()=>typeof window<"u"&&typeof window.document<"u",Wn=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",Kn=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),Lr=()=>typeof Deno<"u",Qn=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!Lr(),Yn=()=>{let n;return Jn()?n="browser":Qn()?n="node":Wn()?n="webworker":Kn()?n="jsdom":Lr()?n="deno":n="other",n};let Qt;async function Xn(){return Qt===void 0&&(Qt={library:"langchain-js",runtime:Yn()}),Qt}function $e(n){try{return typeof process<"u"?Kt==null?void 0:Kt[n]:void 0}catch{return}}class ea{}class Ke extends ea{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,Ir(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:$e("LANGCHAIN_CALLBACKS_BACKGROUND")!=="true"}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.awaitHandlers=e._awaitHandler??this.awaitHandlers)}copy(){return new this.constructor(this)}toJSON(){return Ee.prototype.toJSON.call(this)}toJSONNotImplemented(){return Ee.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class t extends Ke{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:ie()}),Object.assign(this,e)}}return new t}}var Yt={exports:{}};Yt.exports,function(n){const t=(s=0)=>i=>`\x1B[${38+s};5;${i}m`,r=(s=0)=>(i,o,u)=>`\x1B[${38+s};2;${i};${o};${u}m`;function a(){const s=new Map,i={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};i.color.gray=i.color.blackBright,i.bgColor.bgGray=i.bgColor.bgBlackBright,i.color.grey=i.color.blackBright,i.bgColor.bgGrey=i.bgColor.bgBlackBright;for(const[o,u]of Object.entries(i)){for(const[c,l]of Object.entries(u))i[c]={open:`\x1B[${l[0]}m`,close:`\x1B[${l[1]}m`},u[c]=i[c],s.set(l[0],l[1]);Object.defineProperty(i,o,{value:u,enumerable:!1})}return Object.defineProperty(i,"codes",{value:s,enumerable:!1}),i.color.close="\x1B[39m",i.bgColor.close="\x1B[49m",i.color.ansi256=t(),i.color.ansi16m=r(),i.bgColor.ansi256=t(10),i.bgColor.ansi16m=r(10),Object.defineProperties(i,{rgbToAnsi256:{value:(o,u,c)=>o===u&&u===c?o<8?16:o>248?231:Math.round((o-8)/247*24)+232:16+36*Math.round(o/255*5)+6*Math.round(u/255*5)+Math.round(c/255*5),enumerable:!1},hexToRgb:{value:o=>{const u=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(o.toString(16));if(!u)return[0,0,0];let{colorString:c}=u.groups;c.length===3&&(c=c.split("").map(d=>d+d).join(""));const l=Number.parseInt(c,16);return[l>>16&255,l>>8&255,l&255]},enumerable:!1},hexToAnsi256:{value:o=>i.rgbToAnsi256(...i.hexToRgb(o)),enumerable:!1}}),i}Object.defineProperty(n,"exports",{enumerable:!0,get:a})}(Yt);var ta=Yt.exports,Dr=de(ta);function Xt(n,e){return n&&!Array.isArray(n)&&typeof n=="object"?n:{[e]:n}}function ra(n){return n.replace(/[-:.]/g,"")}function na(n,e){return ra(`${new Date(n).toISOString().slice(0,-1)}000Z`)+e}class bt extends Ke{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}stringifyError(e){return e instanceof Error?e.message+(e!=null&&e.stack?`

${e.stack}`:""):typeof e=="string"?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}async _startTrace(e){var a;const t=na(e.start_time,e.id),r={...e};if(r.parent_run_id!==void 0){const s=this.runMap.get(r.parent_run_id);s&&(this._addChildRun(s,r),s.child_execution_order=Math.max(s.child_execution_order,r.child_execution_order),r.trace_id=s.trace_id,s.dotted_order!==void 0&&(r.dotted_order=[s.dotted_order,t].join(".")))}else r.trace_id=r.id,r.dotted_order=t;this.runMap.set(r.id,r),await((a=this.onRunCreate)==null?void 0:a.call(this,r))}async _endTrace(e){var r;const t=e.parent_run_id!==void 0&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await((r=this.onRunUpdate)==null?void 0:r.call(this,e))}_getExecutionOrder(e){const t=e!==void 0&&this.runMap.get(e);return t?t.child_execution_order+1:1}async handleLLMStart(e,t,r,a,s,i,o,u){var f;const c=this._getExecutionOrder(a),l=Date.now(),d=o?{...s,metadata:o}:s,h={id:r,name:u??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{prompts:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:d??{},tags:i||[]};return await this._startTrace(h),await((f=this.onLLMStart)==null?void 0:f.call(this,h)),h}async handleChatModelStart(e,t,r,a,s,i,o,u){var f;const c=this._getExecutionOrder(a),l=Date.now(),d=o?{...s,metadata:o}:s,h={id:r,name:u??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{messages:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:d??{},tags:i||[]};return await this._startTrace(h),await((f=this.onLLMStart)==null?void 0:f.call(this,h)),h}async handleLLMEnd(e,t){var a;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="llm")throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.outputs=e,r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((a=this.onLLMEnd)==null?void 0:a.call(this,r)),await this._endTrace(r),r}async handleLLMError(e,t){var a;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="llm")throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((a=this.onLLMError)==null?void 0:a.call(this,r)),await this._endTrace(r),r}async handleChainStart(e,t,r,a,s,i,o,u){var h;const c=this._getExecutionOrder(a),l=Date.now(),d={id:r,name:u??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:t,execution_order:c,child_execution_order:c,run_type:o??"chain",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return await this._startTrace(d),await((h=this.onChainStart)==null?void 0:h.call(this,d)),d}async handleChainEnd(e,t,r,a,s){var o;const i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.outputs=Xt(e,"output"),i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),(s==null?void 0:s.inputs)!==void 0&&(i.inputs=Xt(s.inputs,"input")),await((o=this.onChainEnd)==null?void 0:o.call(this,i)),await this._endTrace(i),i}async handleChainError(e,t,r,a,s){var o;const i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),(s==null?void 0:s.inputs)!==void 0&&(i.inputs=Xt(s.inputs,"input")),await((o=this.onChainError)==null?void 0:o.call(this,i)),await this._endTrace(i),i}async handleToolStart(e,t,r,a,s,i,o){var d;const u=this._getExecutionOrder(a),c=Date.now(),l={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{input:t},execution_order:u,child_execution_order:u,run_type:"tool",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return await this._startTrace(l),await((d=this.onToolStart)==null?void 0:d.call(this,l)),l}async handleToolEnd(e,t){var a;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((a=this.onToolEnd)==null?void 0:a.call(this,r)),await this._endTrace(r),r}async handleToolError(e,t){var a;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((a=this.onToolError)==null?void 0:a.call(this,r)),await this._endTrace(r),r}async handleAgentAction(e,t){var s;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="chain")return;const a=r;a.actions=a.actions||[],a.actions.push(e),a.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await((s=this.onAgentAction)==null?void 0:s.call(this,r))}async handleAgentEnd(e,t){var a;const r=this.runMap.get(t);!r||(r==null?void 0:r.run_type)!=="chain"||(r.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await((a=this.onAgentEnd)==null?void 0:a.call(this,r)))}async handleRetrieverStart(e,t,r,a,s,i,o){var d;const u=this._getExecutionOrder(a),c=Date.now(),l={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{query:t},execution_order:u,child_execution_order:u,run_type:"retriever",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return await this._startTrace(l),await((d=this.onRetrieverStart)==null?void 0:d.call(this,l)),l}async handleRetrieverEnd(e,t){var a;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((a=this.onRetrieverEnd)==null?void 0:a.call(this,r)),await this._endTrace(r),r}async handleRetrieverError(e,t){var a;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((a=this.onRetrieverError)==null?void 0:a.call(this,r)),await this._endTrace(r),r}async handleText(e,t){var a;const r=this.runMap.get(t);!r||(r==null?void 0:r.run_type)!=="chain"||(r.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await((a=this.onText)==null?void 0:a.call(this,r)))}async handleLLMNewToken(e,t,r,a,s,i){var u;const o=this.runMap.get(r);if(!o||(o==null?void 0:o.run_type)!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return o.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:t,chunk:i==null?void 0:i.chunk}}),await((u=this.onLLMNewToken)==null?void 0:u.call(this,o,e,{chunk:i==null?void 0:i.chunk})),o}}function B(n,e){return`${n.open}${e}${n.close}`}function X(n,e){try{return JSON.stringify(n,null,2)}catch{return e}}function be(n){if(!n.end_time)return"";const e=n.end_time-n.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}const{color:z}=Dr;class Mr extends bt{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){const t=[];let r=e;for(;r.parent_run_id;){const a=this.runMap.get(r.parent_run_id);if(a)t.push(a),r=a;else break}return t}getBreadcrumbs(e){const r=[...this.getParents(e).reverse(),e].map((a,s,i)=>{const o=`${a.execution_order}:${a.run_type}:${a.name}`;return s===i.length-1?B(Dr.bold,o):o}).join(" > ");return B(z.grey,r)}onChainStart(e){const t=this.getBreadcrumbs(e);console.log(`${B(z.green,"[chain/start]")} [${t}] Entering Chain run with input: ${X(e.inputs,"[inputs]")}`)}onChainEnd(e){const t=this.getBreadcrumbs(e);console.log(`${B(z.cyan,"[chain/end]")} [${t}] [${be(e)}] Exiting Chain run with output: ${X(e.outputs,"[outputs]")}`)}onChainError(e){const t=this.getBreadcrumbs(e);console.log(`${B(z.red,"[chain/error]")} [${t}] [${be(e)}] Chain run errored with error: ${X(e.error,"[error]")}`)}onLLMStart(e){const t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(a=>a.trim())}:e.inputs;console.log(`${B(z.green,"[llm/start]")} [${t}] Entering LLM run with input: ${X(r,"[inputs]")}`)}onLLMEnd(e){const t=this.getBreadcrumbs(e);console.log(`${B(z.cyan,"[llm/end]")} [${t}] [${be(e)}] Exiting LLM run with output: ${X(e.outputs,"[response]")}`)}onLLMError(e){const t=this.getBreadcrumbs(e);console.log(`${B(z.red,"[llm/error]")} [${t}] [${be(e)}] LLM run errored with error: ${X(e.error,"[error]")}`)}onToolStart(e){var r;const t=this.getBreadcrumbs(e);console.log(`${B(z.green,"[tool/start]")} [${t}] Entering Tool run with input: "${(r=e.inputs.input)==null?void 0:r.trim()}"`)}onToolEnd(e){var r,a;const t=this.getBreadcrumbs(e);console.log(`${B(z.cyan,"[tool/end]")} [${t}] [${be(e)}] Exiting Tool run with output: "${(a=(r=e.outputs)==null?void 0:r.output)==null?void 0:a.trim()}"`)}onToolError(e){const t=this.getBreadcrumbs(e);console.log(`${B(z.red,"[tool/error]")} [${t}] [${be(e)}] Tool run errored with error: ${X(e.error,"[error]")}`)}onRetrieverStart(e){const t=this.getBreadcrumbs(e);console.log(`${B(z.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${X(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const t=this.getBreadcrumbs(e);console.log(`${B(z.cyan,"[retriever/end]")} [${t}] [${be(e)}] Exiting Retriever run with output: ${X(e.outputs,"[outputs]")}`)}onRetrieverError(e){const t=this.getBreadcrumbs(e);console.log(`${B(z.red,"[retriever/error]")} [${t}] [${be(e)}] Retriever run errored with error: ${X(e.error,"[error]")}`)}onAgentAction(e){const t=e,r=this.getBreadcrumbs(e);console.log(`${B(z.blue,"[agent/action]")} [${r}] Agent selected action: ${X(t.actions[t.actions.length-1],"[action]")}`)}}var _t={exports:{}},Ur={};function W(n,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(n)),this._timeouts=n,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}var aa=W;W.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},W.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},W.prototype.retry=function(n){if(this._timeout&&clearTimeout(this._timeout),!n)return!1;var e=new Date().getTime();if(n&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(n),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(n);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var r=this;return this._timer=setTimeout(function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout(function(){r._operationTimeoutCb(r._attempts)},r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)},t),this._options.unref&&this._timer.unref(),!0},W.prototype.attempt=function(n,e){this._fn=n,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)},W.prototype.try=function(n){console.log("Using RetryOperation.try() is deprecated"),this.attempt(n)},W.prototype.start=function(n){console.log("Using RetryOperation.start() is deprecated"),this.attempt(n)},W.prototype.start=W.prototype.try,W.prototype.errors=function(){return this._errors},W.prototype.attempts=function(){return this._attempts},W.prototype.mainError=function(){if(this._errors.length===0)return null;for(var n={},e=null,t=0,r=0;r<this._errors.length;r++){var a=this._errors[r],s=a.message,i=(n[s]||0)+1;n[s]=i,i>=t&&(e=a,t=i)}return e},function(n){var e=aa;n.operation=function(t){var r=n.timeouts(t);return new e(r,{forever:t&&(t.forever||t.retries===1/0),unref:t&&t.unref,maxRetryTime:t&&t.maxRetryTime})},n.timeouts=function(t){if(t instanceof Array)return[].concat(t);var r={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var a in t)r[a]=t[a];if(r.minTimeout>r.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var s=[],i=0;i<r.retries;i++)s.push(this.createTimeout(i,r));return t&&t.forever&&!s.length&&s.push(this.createTimeout(i,r)),s.sort(function(o,u){return o-u}),s},n.createTimeout=function(t,r){var a=r.randomize?Math.random()+1:1,s=Math.round(a*Math.max(r.minTimeout,1)*Math.pow(r.factor,t));return s=Math.min(s,r.maxTimeout),s},n.wrap=function(t,r,a){if(r instanceof Array&&(a=r,r=null),!a){a=[];for(var s in t)typeof t[s]=="function"&&a.push(s)}for(var i=0;i<a.length;i++){var o=a[i],u=t[o];t[o]=(function(l){var d=n.operation(r),h=Array.prototype.slice.call(arguments,1),f=h.pop();h.push(function(y){d.retry(y)||(y&&(arguments[0]=d.mainError()),f.apply(this,arguments))}),d.attempt(function(){l.apply(t,h)})}).bind(t,u),t[o].options=r}}}(Ur);var sa=Ur;const ia=sa,oa=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class Zr extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const ua=(n,e,t)=>{const r=t.retries-(e-1);return n.attemptNumber=e,n.retriesLeft=r,n},ca=n=>oa.includes(n),Br=(n,e)=>new Promise((t,r)=>{e={onFailedAttempt:()=>{},retries:10,...e};const a=ia.operation(e);a.attempt(async s=>{try{t(await n(s))}catch(i){if(!(i instanceof Error)){r(new TypeError(`Non-error was thrown: "${i}". You should only throw errors.`));return}if(i instanceof Zr)a.stop(),r(i.originalError);else if(i instanceof TypeError&&!ca(i.message))a.stop(),r(i);else{ua(i,s,e);try{await e.onFailedAttempt(i)}catch(o){r(o);return}a.retry(i)||r(a.mainError())}}})});_t.exports=Br,_t.exports.default=Br,_t.exports.AbortError=Zr;var la=_t.exports,vt=de(la),Fr={},zr={exports:{}};(function(n){var e=Object.prototype.hasOwnProperty,t="~";function r(){}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(t=!1));function a(u,c,l){this.fn=u,this.context=c,this.once=l||!1}function s(u,c,l,d,h){if(typeof l!="function")throw new TypeError("The listener must be a function");var f=new a(l,d||u,h),y=t?t+c:c;return u._events[y]?u._events[y].fn?u._events[y]=[u._events[y],f]:u._events[y].push(f):(u._events[y]=f,u._eventsCount++),u}function i(u,c){--u._eventsCount===0?u._events=new r:delete u._events[c]}function o(){this._events=new r,this._eventsCount=0}o.prototype.eventNames=function(){var c=[],l,d;if(this._eventsCount===0)return c;for(d in l=this._events)e.call(l,d)&&c.push(t?d.slice(1):d);return Object.getOwnPropertySymbols?c.concat(Object.getOwnPropertySymbols(l)):c},o.prototype.listeners=function(c){var l=t?t+c:c,d=this._events[l];if(!d)return[];if(d.fn)return[d.fn];for(var h=0,f=d.length,y=new Array(f);h<f;h++)y[h]=d[h].fn;return y},o.prototype.listenerCount=function(c){var l=t?t+c:c,d=this._events[l];return d?d.fn?1:d.length:0},o.prototype.emit=function(c,l,d,h,f,y){var w=t?t+c:c;if(!this._events[w])return!1;var _=this._events[w],A=arguments.length,I,E;if(_.fn){switch(_.once&&this.removeListener(c,_.fn,void 0,!0),A){case 1:return _.fn.call(_.context),!0;case 2:return _.fn.call(_.context,l),!0;case 3:return _.fn.call(_.context,l,d),!0;case 4:return _.fn.call(_.context,l,d,h),!0;case 5:return _.fn.call(_.context,l,d,h,f),!0;case 6:return _.fn.call(_.context,l,d,h,f,y),!0}for(E=1,I=new Array(A-1);E<A;E++)I[E-1]=arguments[E];_.fn.apply(_.context,I)}else{var Q=_.length,R;for(E=0;E<Q;E++)switch(_[E].once&&this.removeListener(c,_[E].fn,void 0,!0),A){case 1:_[E].fn.call(_[E].context);break;case 2:_[E].fn.call(_[E].context,l);break;case 3:_[E].fn.call(_[E].context,l,d);break;case 4:_[E].fn.call(_[E].context,l,d,h);break;default:if(!I)for(R=1,I=new Array(A-1);R<A;R++)I[R-1]=arguments[R];_[E].fn.apply(_[E].context,I)}}return!0},o.prototype.on=function(c,l,d){return s(this,c,l,d,!1)},o.prototype.once=function(c,l,d){return s(this,c,l,d,!0)},o.prototype.removeListener=function(c,l,d,h){var f=t?t+c:c;if(!this._events[f])return this;if(!l)return i(this,f),this;var y=this._events[f];if(y.fn)y.fn===l&&(!h||y.once)&&(!d||y.context===d)&&i(this,f);else{for(var w=0,_=[],A=y.length;w<A;w++)(y[w].fn!==l||h&&!y[w].once||d&&y[w].context!==d)&&_.push(y[w]);_.length?this._events[f]=_.length===1?_[0]:_:i(this,f)}return this},o.prototype.removeAllListeners=function(c){var l;return c?(l=t?t+c:c,this._events[l]&&i(this,l)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=t,o.EventEmitter=o,n.exports=o})(zr);var da=zr.exports,wt={exports:{}},ha=(n,e)=>(e=e||(()=>{}),n.then(t=>new Promise(r=>{r(e())}).then(()=>t),t=>new Promise(r=>{r(e())}).then(()=>{throw t})));const fa=ha;class Hr extends Error{constructor(e){super(e),this.name="TimeoutError"}}const Vr=(n,e,t)=>new Promise((r,a)=>{if(typeof e!="number"||e<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(e===1/0){r(n);return}const s=setTimeout(()=>{if(typeof t=="function"){try{r(t())}catch(u){a(u)}return}const i=typeof t=="string"?t:`Promise timed out after ${e} milliseconds`,o=t instanceof Error?t:new Hr(i);typeof n.cancel=="function"&&n.cancel(),a(o)},e);fa(n.then(r,a),()=>{clearTimeout(s)})});wt.exports=Vr,wt.exports.default=Vr,wt.exports.TimeoutError=Hr;var pa=wt.exports,er={},tr={};Object.defineProperty(tr,"__esModule",{value:!0});function ma(n,e,t){let r=0,a=n.length;for(;a>0;){const s=a/2|0;let i=r+s;t(n[i],e)<=0?(r=++i,a-=s+1):a=s}return r}tr.default=ma,Object.defineProperty(er,"__esModule",{value:!0});const ya=tr;class ga{constructor(){this._queue=[]}enqueue(e,t){t=Object.assign({priority:0},t);const r={priority:t.priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority){this._queue.push(r);return}const a=ya.default(this._queue,r,(s,i)=>i.priority-s.priority);this._queue.splice(a,0,r)}dequeue(){const e=this._queue.shift();return e==null?void 0:e.run}filter(e){return this._queue.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this._queue.length}}er.default=ga,Object.defineProperty(Fr,"__esModule",{value:!0});const ba=da,Gr=pa,_a=er,xt=()=>{},va=new Gr.TimeoutError;class wa extends ba{constructor(e){var t,r,a,s;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=xt,this._resolveIdle=xt,e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:_a.default},e),!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(r=(t=e.intervalCap)===null||t===void 0?void 0:t.toString())!==null&&r!==void 0?r:""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(s=(a=e.interval)===null||a===void 0?void 0:a.toString())!==null&&s!==void 0?s:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||e.interval===0,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=e.throwOnTimeout===!0,this._isPaused=e.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=xt,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=xt,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const e=Date.now();if(this._intervalId===void 0){const t=this._intervalEnd-e;if(t<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},t)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const t=this._queue.dequeue();return t?(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||this._intervalId!==void 0||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise((r,a)=>{const s=async()=>{this._pendingCount++,this._intervalCount++;try{const i=this._timeout===void 0&&t.timeout===void 0?e():Gr.default(Promise.resolve(e()),t.timeout===void 0?this._timeout:t.timeout,()=>{(t.throwOnTimeout===void 0?this._throwOnTimeout:t.throwOnTimeout)&&a(va)});r(await i)}catch(i){a(i)}this._next()};this._queue.enqueue(s,t),this._tryToStartAnother(),this.emit("add")})}async addAll(e,t){return Promise.all(e.map(async r=>this.add(r,t)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(this._queue.size!==0)return new Promise(e=>{const t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}})}async onIdle(){if(!(this._pendingCount===0&&this._queue.size===0))return new Promise(e=>{const t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}})}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}}var he=Fr.default=wa;const xa=[400,401,403,404,405,406,407,408],ka=[409];let qr=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6;const t="default"in he?he.default:he;this.queue=new t({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e==null?void 0:e.onFailedResponseHook}call(e,...t){const r=this.onFailedResponseHook;return this.queue.add(()=>vt(()=>e(...t).catch(a=>{throw a instanceof Error?a:new Error(a)}),{async onFailedAttempt(a){if(a.message.startsWith("Cancel")||a.message.startsWith("TimeoutError")||a.message.startsWith("AbortError")||(a==null?void 0:a.code)==="ECONNABORTED")throw a;const s=a==null?void 0:a.response,i=s==null?void 0:s.status;if(i){if(xa.includes(+i))throw a;if(ka.includes(+i))return;r&&await r(s)}},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((a,s)=>{var i;(i=e.signal)==null||i.addEventListener("abort",()=>{s(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}};function Jr(n){return typeof(n==null?void 0:n._getType)=="function"}function Wr(n){const e={type:n._getType(),data:{content:n.content}};return n!=null&&n.additional_kwargs&&Object.keys(n.additional_kwargs).length>0&&(e.data.additional_kwargs={...n.additional_kwargs}),e}var Qe={};let fe;const Ta=()=>typeof window<"u"&&typeof window.document<"u",Oa=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",Ea=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),Kr=()=>typeof Deno<"u",Pa=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!Kr(),Sa=()=>fe||(Ta()?fe="browser":Pa()?fe="node":Oa()?fe="webworker":Ea()?fe="jsdom":Kr()?fe="deno":fe="other",fe);let rr;async function Aa(){if(rr===void 0){const n=Sa(),e=Ra();rr={library:"langsmith",runtime:n,sdk:"langsmith-js",sdk_version:Yr,...e}}return rr}function Ca(){const n=Ia()||{},e={},t=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION"];for(const[r,a]of Object.entries(n))r.startsWith("LANGCHAIN_")&&typeof a=="string"&&!t.includes(r)&&!r.toLowerCase().includes("key")&&!r.toLowerCase().includes("secret")&&!r.toLowerCase().includes("token")&&(r==="LANGCHAIN_REVISION_ID"?e.revision_id=a:e[r]=a);return e}function Ia(){try{return typeof process<"u"&&Qe?Object.entries(Qe).reduce((n,[e,t])=>(n[e]=String(t),n),{}):void 0}catch{return}}function Pe(n){try{return typeof process<"u"?Qe==null?void 0:Qe[n]:void 0}catch{return}}let nr;function Ra(){if(nr!==void 0)return nr;const n=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],e={};for(const t of n){const r=Pe(t);r!==void 0&&(e[t]=r)}return nr=e,e}async function Qr(n){const e=await Aa(),t=Ca();return n.map(r=>{const a=r.extra??{},s=a.metadata;return r.extra={...a,runtime:{...e,...a==null?void 0:a.runtime},metadata:{...t,...t.revision_id||r.revision_id?{revision_id:r.revision_id??t.revision_id}:{},...s}},r})}const Na=()=>{const n=Pe("LANGCHAIN_TRACING_SAMPLING_RATE");if(n===void 0)return;const e=parseFloat(n);if(e<0||e>1)throw new Error(`LANGCHAIN_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${e}`);return e},ja=n=>{const t=n.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return t==="localhost"||t==="127.0.0.1"||t==="::1"},_e=async(n,e)=>{const t=await n.text();if(!n.ok)throw new Error(`Failed to ${e}: ${n.status} ${n.statusText} ${t}`)};async function $a(n){const e=[];for await(const t of n)e.push(t);return e}function ar(n){if(n!==void 0)return n.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}function N(n){if(!jr(n))throw new Error(`Invalid UUID: ${n}`)}const La=async n=>{if((n==null?void 0:n.status)===429){const e=parseInt(n.headers.get("retry-after")??"30",10)*1e3;if(e>0)return await new Promise(t=>setTimeout(t,e)),!0}return!1};class Da{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]})}get size(){return this.items.length}push(e){return new Promise(t=>{this.items.push([e,t])})}pop(e){if(e<1)throw new Error("Number of items to pop off may not be less than 1.");const t=[];for(;t.length<e&&this.items.length;){const r=this.items.shift();if(r)t.push(r);else break}return[t.map(r=>r[0]),()=>t.forEach(r=>r[1]())]}}const Ma=20971520;class sr{constructor(e={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sampledPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"batchEndpointSupported",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new Da}),Object.defineProperty(this,"pendingAutoBatchedRunLimit",{enumerable:!0,configurable:!0,writable:!0,value:100}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchInitialDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:50}),Object.defineProperty(this,"serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const t=sr.getDefaultClientConfig();this.tracingSampleRate=Na(),this.apiUrl=ar(e.apiUrl??t.apiUrl)??"",this.apiKey=ar(e.apiKey??t.apiKey),this.webUrl=ar(e.webUrl??t.webUrl),this.timeout_ms=e.timeout_ms??12e3,this.caller=new qr(e.callerOptions??{}),this.batchIngestCaller=new qr({...e.callerOptions??{},onFailedResponseHook:La}),this.hideInputs=e.hideInputs??t.hideInputs,this.hideOutputs=e.hideOutputs??t.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.pendingAutoBatchedRunLimit=e.pendingAutoBatchedRunLimit??this.pendingAutoBatchedRunLimit}static getDefaultClientConfig(){const e=Pe("LANGCHAIN_API_KEY"),t=Pe("LANGCHAIN_ENDPOINT")??"https://api.smith.langchain.com",r=Pe("LANGCHAIN_HIDE_INPUTS")==="true",a=Pe("LANGCHAIN_HIDE_OUTPUTS")==="true";return{apiUrl:t,apiKey:e,webUrl:void 0,hideInputs:r,hideOutputs:a}}getHostUrl(){return this.webUrl?this.webUrl:ja(this.apiUrl)?(this.webUrl="http://localhost","http://localhost"):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com","https://dev.smith.langchain.com"):(this.webUrl="https://smith.langchain.com","https://smith.langchain.com")}get headers(){const e={"User-Agent":`langsmith-js/${Yr}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}processInputs(e){return this.hideInputs===!1?e:this.hideInputs===!0?{}:typeof this.hideInputs=="function"?this.hideInputs(e):e}processOutputs(e){return this.hideOutputs===!1?e:this.hideOutputs===!0?{}:typeof this.hideOutputs=="function"?this.hideOutputs(e):e}prepareRunCreateOrUpdateInputs(e){const t={...e};return t.inputs!==void 0&&(t.inputs=this.processInputs(t.inputs)),t.outputs!==void 0&&(t.outputs=this.processOutputs(t.outputs)),t}async _getResponse(e,t){const r=(t==null?void 0:t.toString())??"",a=`${this.apiUrl}${e}?${r}`,s=await this.caller.call(fetch,a,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!s.ok)throw new Error(`Failed to fetch ${e}: ${s.status} ${s.statusText}`);return s}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams){let r=Number(t.get("offset"))||0;const a=Number(t.get("limit"))||100;for(;;){t.set("offset",String(r)),t.set("limit",String(a));const s=`${this.apiUrl}${e}?${t}`,i=await this.caller.call(fetch,s,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!i.ok)throw new Error(`Failed to fetch ${e}: ${i.status} ${i.statusText}`);const o=await i.json();if(o.length===0||(yield o,o.length<a))break;r+=o.length}}async*_getCursorPaginatedList(e,t=null,r="POST",a="runs"){const s=t?{...t}:{};for(;;){const o=await(await this.caller.call(fetch,`${this.apiUrl}${e}`,{method:r,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),body:JSON.stringify(s)})).json();if(!o||!o[a])break;yield o[a];const u=o.cursors;if(!u||!u.next)break;s.cursor=u.next}}_filterForSampling(e,t=!1){if(this.tracingSampleRate===void 0)return e;if(t){const r=[];for(const a of e)this.sampledPostUuids.has(a.id)&&(r.push(a),this.sampledPostUuids.delete(a.id));return r}else{const r=[];for(const a of e)Math.random()<this.tracingSampleRate&&(r.push(a),this.sampledPostUuids.add(a.id));return r}}async drainAutoBatchQueue(){for(;this.autoBatchQueue.size>=0;){const[e,t]=this.autoBatchQueue.pop(this.pendingAutoBatchedRunLimit);if(!e.length){t();return}try{await this.batchIngestRuns({runCreates:e.filter(r=>r.action==="create").map(r=>r.item),runUpdates:e.filter(r=>r.action==="update").map(r=>r.item)})}finally{t()}}}async processRunOperation(e,t){const r=this.autoBatchTimeout;clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0;const a=this.autoBatchQueue.push(e);return(t||this.autoBatchQueue.size>this.pendingAutoBatchedRunLimit)&&await this.drainAutoBatchQueue(),this.autoBatchQueue.size>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue().catch(console.error)},r?this.autoBatchAggregationDelayMs:this.autoBatchInitialDelayMs)),a}async _getServerInfo(){const e=await fetch(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms)});if(!e.ok)throw await e.text(),new Error("Failed to retrieve server info.");return e.json()}async batchEndpointIsSupported(){try{this.serverInfo=await this._getServerInfo()}catch{return!1}return!0}async createRun(e){if(!this._filterForSampling([e]).length)return;const t={...this.headers,"Content-Type":"application/json"},r=e.project_name;delete e.project_name;const a=this.prepareRunCreateOrUpdateInputs({session_name:r,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&a.trace_id!==void 0&&a.dotted_order!==void 0){this.processRunOperation({action:"create",item:a}).catch(console.error);return}const s=await Qr([a]),i=await this.caller.call(fetch,`${this.apiUrl}/runs`,{method:"POST",headers:t,body:JSON.stringify(s[0]),signal:AbortSignal.timeout(this.timeout_ms)});await _e(i,"create run")}async batchIngestRuns({runCreates:e,runUpdates:t}){var c,l;if(e===void 0&&t===void 0)return;let r=(e==null?void 0:e.map(d=>this.prepareRunCreateOrUpdateInputs(d)))??[],a=(t==null?void 0:t.map(d=>this.prepareRunCreateOrUpdateInputs(d)))??[];if(r.length>0&&a.length>0){const d=r.reduce((f,y)=>(y.id&&(f[y.id]=y),f),{}),h=[];for(const f of a)f.id!==void 0&&d[f.id]?d[f.id]={...d[f.id],...f}:h.push(f);r=Object.values(d),a=h}const s={post:this._filterForSampling(r),patch:this._filterForSampling(a,!0)};if(!s.post.length&&!s.patch.length)return;if(r=await Qr(r),this.batchEndpointSupported===void 0&&(this.batchEndpointSupported=await this.batchEndpointIsSupported()),!this.batchEndpointSupported){this.autoBatchTracing=!1;for(const d of s.post)await this.createRun(d);for(const d of s.patch)d.id!==void 0&&await this.updateRun(d.id,d);return}const i=((l=(c=this.serverInfo)==null?void 0:c.batch_ingest_config)==null?void 0:l.size_limit_bytes)??Ma,o={post:[],patch:[]};let u=0;for(const d of["post","patch"]){const h=d,f=s[h].reverse();let y=f.pop();for(;y!==void 0;){const w=JSON.stringify(y);u>0&&u+w.length>i&&(await this._postBatchIngestRuns(JSON.stringify(o)),u=0,o.post=[],o.patch=[]),u+=w.length,o[h].push(y),y=f.pop()}}(o.post.length>0||o.patch.length>0)&&await this._postBatchIngestRuns(JSON.stringify(o))}async _postBatchIngestRuns(e){const t={...this.headers,"Content-Type":"application/json",Accept:"application/json"},r=await this.batchIngestCaller.call(fetch,`${this.apiUrl}/runs/batch`,{method:"POST",headers:t,body:e,signal:AbortSignal.timeout(this.timeout_ms)});await _e(r,"batch create run")}async updateRun(e,t){N(e),t.inputs&&(t.inputs=this.processInputs(t.inputs)),t.outputs&&(t.outputs=this.processOutputs(t.outputs));const r={...t,id:e};if(!this._filterForSampling([r],!0).length)return;if(this.autoBatchTracing&&r.trace_id!==void 0&&r.dotted_order!==void 0){if(t.end_time!==void 0&&r.parent_run_id===void 0){await this.processRunOperation({action:"update",item:r},!0);return}else this.processRunOperation({action:"update",item:r}).catch(console.error);return}const a={...this.headers,"Content-Type":"application/json"},s=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:a,body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms)});await _e(s,"update run")}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){N(e);let r=await this._get(`/runs/${e}`);return t&&r.child_run_ids&&(r=await this._loadChildRuns(r)),r}async getRunUrl({runId:e,run:t,projectOpts:r}){if(t!==void 0){let a;t.session_id?a=t.session_id:r!=null&&r.projectName?a=(await this.readProject({projectName:r==null?void 0:r.projectName})).id:r!=null&&r.projectId?a=r==null?void 0:r.projectId:a=(await this.readProject({projectName:Pe("LANGCHAIN_PROJECT")||"default"})).id;const s=await this._getTenantId();return`${this.getHostUrl()}/o/${s}/projects/p/${a}/r/${t.id}?poll=true`}else if(e!==void 0){const a=await this.readRun(e);if(!a.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${a.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(e){const t=await $a(this.listRuns({id:e.child_run_ids})),r={},a={};t.sort((s,i)=>((s==null?void 0:s.dotted_order)??"").localeCompare((i==null?void 0:i.dotted_order)??""));for(const s of t){if(s.parent_run_id===null||s.parent_run_id===void 0)throw new Error(`Child run ${s.id} has no parent`);s.parent_run_id in r||(r[s.parent_run_id]=[]),r[s.parent_run_id].push(s),a[s.id]=s}e.child_runs=r[e.id]||[];for(const s in r)s!==e.id&&(a[s].child_runs=r[s]);return e}async*listRuns(e){const{projectId:t,projectName:r,parentRunId:a,traceId:s,referenceExampleId:i,startTime:o,executionOrder:u,runType:c,error:l,id:d,query:h,filter:f,traceFilter:y,treeFilter:w,limit:_}=e;let A=[];if(t&&(A=Array.isArray(t)?t:[t]),r){const E=Array.isArray(r)?r:[r],Q=await Promise.all(E.map(R=>this.readProject({projectName:R}).then(Ft=>Ft.id)));A.push(...Q)}const I={session:A.length?A:null,run_type:c,reference_example:i,query:h,filter:f,trace_filter:y,tree_filter:w,execution_order:u,parent_run:a,start_time:o?o.toISOString():null,error:l,id:d,limit:_,trace:s};for await(const E of this._getCursorPaginatedList("/runs/query",I))yield*E}async shareRun(e,{shareId:t}={}){const r={run_id:e,share_token:t||ie()};N(e);const s=await(await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms)})).json();if(s===null||!("share_token"in s))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${s.share_token}/r`}async unshareRun(e){N(e);const t=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});await _e(t,"unshare run")}async readRunSharedLink(e){N(e);const r=await(await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)})).json();if(!(r===null||!("share_token"in r)))return`${this.getHostUrl()}/public/${r.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){const r=new URLSearchParams({share_token:e});if(t!==void 0)for(const i of t)r.append("id",i);return N(e),await(await this.caller.call(fetch,`${this.apiUrl}/public/${e}/runs${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)})).json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),N(e);const a=await(await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)})).json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);const r={dataset_id:e};N(e);const s=await(await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms)})).json();return s.url=`${this.getHostUrl()}/public/${s.share_token}/d`,s}async unshareDataset(e){N(e);const t=await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});await _e(t,"unshare dataset")}async readSharedDataset(e){return N(e),await(await this.caller.call(fetch,`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)})).json()}async createProject({projectName:e,description:t=null,metadata:r=null,upsert:a=!1,projectExtra:s=null,referenceDatasetId:i=null}){const o=a?"?upsert=true":"",u=`${this.apiUrl}/sessions${o}`,c=s||{};r&&(c.metadata=r);const l={name:e,extra:c,description:t};i!==null&&(l.reference_dataset_id=i);const d=await this.caller.call(fetch,u,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms)}),h=await d.json();if(!d.ok)throw new Error(`Failed to create session ${e}: ${d.status} ${d.statusText}`);return h}async updateProject(e,{name:t=null,description:r=null,metadata:a=null,projectExtra:s=null,endTime:i=null}){const o=`${this.apiUrl}/sessions/${e}`;let u=s;a&&(u={...u||{},metadata:a});const c={name:t,extra:u,description:r,end_time:i?new Date(i).toISOString():null},l=await this.caller.call(fetch,o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms)}),d=await l.json();if(!l.ok)throw new Error(`Failed to update project ${e}: ${l.status} ${l.statusText}`);return d}async hasProject({projectId:e,projectName:t}){let r="/sessions";const a=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)N(e),r+=`/${e}`;else if(t!==void 0)a.append("name",t);else throw new Error("Must provide projectName or projectId");const s=await this.caller.call(fetch,`${this.apiUrl}${r}?${a}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});try{const i=await s.json();return s.ok?Array.isArray(i)?i.length>0:!0:!1}catch{return!1}}async readProject({projectId:e,projectName:t,includeStats:r}){let a="/sessions";const s=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)N(e),a+=`/${e}`;else if(t!==void 0)s.append("name",t);else throw new Error("Must provide projectName or projectId");r!==void 0&&s.append("include_stats",r.toString());const i=await this._get(a,s);let o;if(Array.isArray(i)){if(i.length===0)throw new Error(`Project[id=${e}, name=${t}] not found`);o=i[0]}else o=i;return o}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:r,referenceDatasetId:a,referenceDatasetName:s,referenceFree:i}={}){const o=new URLSearchParams;if(e!==void 0)for(const u of e)o.append("id",u);if(t!==void 0&&o.append("name",t),r!==void 0&&o.append("name_contains",r),a!==void 0)o.append("reference_dataset",a);else if(s!==void 0){const u=await this.readDataset({datasetName:s});o.append("reference_dataset",u.id)}i!==void 0&&o.append("reference_free",i.toString());for await(const u of this._getPaginated("/sessions",o))yield*u}async deleteProject({projectId:e,projectName:t}){let r;if(e===void 0&&t===void 0)throw new Error("Must provide projectName or projectId");if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");e===void 0?r=(await this.readProject({projectName:t})).id:r=e,N(r);const a=await this.caller.call(fetch,`${this.apiUrl}/sessions/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});await _e(a,`delete session ${r} (${t})`)}async uploadCsv({csvFile:e,fileName:t,inputKeys:r,outputKeys:a,description:s,dataType:i,name:o}){const u=`${this.apiUrl}/datasets/upload`,c=new FormData;c.append("file",e,t),r.forEach(h=>{c.append("input_keys",h)}),a.forEach(h=>{c.append("output_keys",h)}),s&&c.append("description",s),i&&c.append("data_type",i),o&&c.append("name",o);const l=await this.caller.call(fetch,u,{method:"POST",headers:this.headers,body:c,signal:AbortSignal.timeout(this.timeout_ms)});if(!l.ok){const h=await l.json();throw h.detail&&h.detail.includes("already exists")?new Error(`Dataset ${t} already exists`):new Error(`Failed to upload CSV: ${l.status} ${l.statusText}`)}return await l.json()}async createDataset(e,{description:t,dataType:r}={}){const a={name:e,description:t};r&&(a.data_type=r);const s=await this.caller.call(fetch,`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms)});if(!s.ok){const o=await s.json();throw o.detail&&o.detail.includes("already exists")?new Error(`Dataset ${e} already exists`):new Error(`Failed to create dataset ${s.status} ${s.statusText}`)}return await s.json()}async readDataset({datasetId:e,datasetName:t}){let r="/datasets";const a=new URLSearchParams({limit:"1"});if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)N(e),r+=`/${e}`;else if(t!==void 0)a.append("name",t);else throw new Error("Must provide datasetName or datasetId");const s=await this._get(r,a);let i;if(Array.isArray(s)){if(s.length===0)throw new Error(`Dataset[id=${e}, name=${t}] not found`);i=s[0]}else i=s;return i}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:r,toVersion:a}){let s=e;if(s===void 0&&t===void 0)throw new Error("Must provide either datasetName or datasetId");if(s!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");s===void 0&&(s=(await this.readDataset({datasetName:t})).id);const i=new URLSearchParams({from_version:typeof r=="string"?r:r.toISOString(),to_version:typeof a=="string"?a:a.toISOString()});return await this._get(`/datasets/${s}/versions/diff`,i)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){const r="/datasets";if(e===void 0)if(t!==void 0)e=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide datasetName or datasetId");return(await(await this._getResponse(`${r}/${e}/openai_ft`)).text()).trim().split(`
`).map(o=>JSON.parse(o))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:r,datasetName:a,datasetNameContains:s}={}){const i="/datasets",o=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(r!==void 0)for(const u of r)o.append("id",u);a!==void 0&&o.append("name",a),s!==void 0&&o.append("name_contains",s);for await(const u of this._getPaginated(i,o))yield*u}async deleteDataset({datasetId:e,datasetName:t}){let r="/datasets",a=e;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(t!==void 0&&(a=(await this.readDataset({datasetName:t})).id),a!==void 0)N(a),r+=`/${a}`;else throw new Error("Must provide datasetName or datasetId");const s=await this.caller.call(fetch,this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!s.ok)throw new Error(`Failed to delete ${r}: ${s.status} ${s.statusText}`);await s.json()}async createExample(e,t,{datasetId:r,datasetName:a,createdAt:s,exampleId:i}){let o=r;if(o===void 0&&a===void 0)throw new Error("Must provide either datasetName or datasetId");if(o!==void 0&&a!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");o===void 0&&(o=(await this.readDataset({datasetName:a})).id);const u=s||new Date,c={dataset_id:o,inputs:e,outputs:t,created_at:u==null?void 0:u.toISOString(),id:i},l=await this.caller.call(fetch,`${this.apiUrl}/examples`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms)});if(!l.ok)throw new Error(`Failed to create example: ${l.status} ${l.statusText}`);return await l.json()}async createExamples(e){const{inputs:t,outputs:r,sourceRunIds:a,exampleIds:s,datasetId:i,datasetName:o}=e;let u=i;if(u===void 0&&o===void 0)throw new Error("Must provide either datasetName or datasetId");if(u!==void 0&&o!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");u===void 0&&(u=(await this.readDataset({datasetName:o})).id);const c=t.map((h,f)=>({dataset_id:u,inputs:h,outputs:r?r[f]:void 0,id:s?s[f]:void 0,source_run_id:a?a[f]:void 0})),l=await this.caller.call(fetch,`${this.apiUrl}/examples/bulk`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms)});if(!l.ok)throw new Error(`Failed to create examples: ${l.status} ${l.statusText}`);return await l.json()}async createLLMExample(e,t,r){return this.createExample({input:e},{output:t},r)}async createChatExample(e,t,r){const a=e.map(i=>Jr(i)?Wr(i):i),s=Jr(t)?Wr(t):t;return this.createExample({input:a},{output:s},r)}async readExample(e){N(e);const t=`/examples/${e}`;return await this._get(t)}async*listExamples({datasetId:e,datasetName:t,exampleIds:r,asOf:a,inlineS3Urls:s}={}){let i;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)i=e;else if(t!==void 0)i=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide a datasetName or datasetId");const o=new URLSearchParams({dataset:i}),u=a?typeof a=="string"?a:a==null?void 0:a.toISOString():void 0;u&&o.append("as_of",u);const c=s??!0;if(o.append("inline_s3_urls",c.toString()),r!==void 0)for(const l of r)o.append("id",l);for await(const l of this._getPaginated("/examples",o))yield*l}async deleteExample(e){N(e);const t=`/examples/${e}`,r=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!r.ok)throw new Error(`Failed to delete ${t}: ${r.status} ${r.statusText}`);await r.json()}async updateExample(e,t){N(e);const r=await this.caller.call(fetch,`${this.apiUrl}/examples/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms)});if(!r.ok)throw new Error(`Failed to update example ${e}: ${r.status} ${r.statusText}`);return await r.json()}async evaluateRun(e,t,{sourceInfo:r,loadChildRuns:a,referenceExample:s}={loadChildRuns:!1}){let i;if(typeof e=="string")i=await this.readRun(e,{loadChildRuns:a});else if(typeof e=="object"&&"id"in e)i=e;else throw new Error(`Invalid run type: ${typeof e}`);i.reference_example_id!==null&&i.reference_example_id!==void 0&&(s=await this.readExample(i.reference_example_id));const o=await t.evaluateRun(i,s);let u=r??{};o.evaluatorInfo&&(u={...u,...o.evaluatorInfo});const c=o.targetRunId??i.id;return await this.createFeedback(c,o.key,{score:o==null?void 0:o.score,value:o==null?void 0:o.value,comment:o==null?void 0:o.comment,correction:o==null?void 0:o.correction,sourceInfo:u,feedbackSourceType:"model",sourceRunId:o==null?void 0:o.sourceRunId})}async createFeedback(e,t,{score:r,value:a,correction:s,comment:i,sourceInfo:o,feedbackSourceType:u="api",sourceRunId:c,feedbackId:l,feedbackConfig:d}){var _;const h={type:u??"api",metadata:o??{}};c!==void 0&&(h==null?void 0:h.metadata)!==void 0&&!h.metadata.__run&&(h.metadata.__run={run_id:c}),(h==null?void 0:h.metadata)!==void 0&&((_=h.metadata.__run)==null?void 0:_.run_id)!==void 0&&N(h.metadata.__run.run_id);const f={id:l??ie(),run_id:e,key:t,score:r,value:a,correction:s,comment:i,feedback_source:h,feedbackConfig:d},y=`${this.apiUrl}/feedback`,w=await this.caller.call(fetch,y,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(f),signal:AbortSignal.timeout(this.timeout_ms)});return await _e(w,"create feedback"),f}async updateFeedback(e,{score:t,value:r,correction:a,comment:s}){const i={};t!=null&&(i.score=t),r!=null&&(i.value=r),a!=null&&(i.correction=a),s!=null&&(i.comment=s),N(e);const o=await this.caller.call(fetch,`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms)});await _e(o,"update feedback")}async readFeedback(e){N(e);const t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){N(e);const t=`/feedback/${e}`,r=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!r.ok)throw new Error(`Failed to delete ${t}: ${r.status} ${r.statusText}`);await r.json()}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:r}={}){const a=new URLSearchParams;if(e&&a.append("run",e.join(",")),t)for(const s of t)a.append("key",s);if(r)for(const s of r)a.append("source",s);for await(const s of this._getPaginated("/feedback",a))yield*s}async createPresignedFeedbackToken(e,t,{expiration:r,feedbackConfig:a}={}){const s={run_id:e,feedback_key:t,feedback_config:a};return r?typeof r=="string"?s.expires_at=r:(r!=null&&r.hours||r!=null&&r.minutes||r!=null&&r.days)&&(s.expires_in=r):s.expires_in={hours:3},await(await this.caller.call(fetch,`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms)})).json()}async*listPresignedFeedbackTokens(e){N(e);const t=new URLSearchParams({run_id:e});for await(const r of this._getPaginated("/feedback/tokens",t))yield*r}}const Yr="0.1.13";class Ua extends bt{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{exampleId:t,projectName:r,client:a}=e;this.projectName=r??$e("LANGCHAIN_PROJECT")??$e("LANGCHAIN_SESSION"),this.exampleId=t,this.client=a??new sr({})}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await Xn()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async onRunCreate(e){const t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async onRunUpdate(e){const t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs,trace_id:e.trace_id,dotted_order:e.dotted_order,parent_run_id:e.parent_run_id};await this.client.updateRun(e.id,t)}getRun(e){return this.runMap.get(e)}}async function Za(){return new Ua}let ir;function Ba(){const n="default"in he?he.default:he;return new n({autoStart:!0,concurrency:1})}async function M(n,e){e===!0?await n():(typeof ir>"u"&&(ir=Ba()),ir.add(n))}class Fa{setHandler(e){return this.setHandlers([e])}}class kt{constructor(e,t,r,a,s,i,o,u){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:u})}async handleText(e){await Promise.all(this.handlers.map(t=>M(async()=>{var r;try{await((r=t.handleText)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){console.error(`Error in handler ${t.constructor.name}, handleText: ${a}`)}},t.awaitHandlers)))}}class za extends kt{getChild(e){const t=new H(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(t=>M(async()=>{var r;if(!t.ignoreRetriever)try{await((r=t.handleRetrieverEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch{console.error(`Error in handler ${t.constructor.name}, handleRetriever`)}},t.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(t=>M(async()=>{var r;if(!t.ignoreRetriever)try{await((r=t.handleRetrieverError)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){console.error(`Error in handler ${t.constructor.name}, handleRetrieverError: ${a}`)}},t.awaitHandlers)))}}class Xr extends kt{async handleLLMNewToken(e,t,r,a,s,i){await Promise.all(this.handlers.map(o=>M(async()=>{var u;if(!o.ignoreLLM)try{await((u=o.handleLLMNewToken)==null?void 0:u.call(o,e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,i))}catch(c){console.error(`Error in handler ${o.constructor.name}, handleLLMNewToken: ${c}`)}},o.awaitHandlers)))}async handleLLMError(e){await Promise.all(this.handlers.map(t=>M(async()=>{var r;if(!t.ignoreLLM)try{await((r=t.handleLLMError)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){console.error(`Error in handler ${t.constructor.name}, handleLLMError: ${a}`)}},t.awaitHandlers)))}async handleLLMEnd(e){await Promise.all(this.handlers.map(t=>M(async()=>{var r;if(!t.ignoreLLM)try{await((r=t.handleLLMEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){console.error(`Error in handler ${t.constructor.name}, handleLLMEnd: ${a}`)}},t.awaitHandlers)))}}class Ha extends kt{getChild(e){const t=new H(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,r,a,s){await Promise.all(this.handlers.map(i=>M(async()=>{var o;if(!i.ignoreChain)try{await((o=i.handleChainError)==null?void 0:o.call(i,e,this.runId,this._parentRunId,this.tags,s))}catch(u){console.error(`Error in handler ${i.constructor.name}, handleChainError: ${u}`)}},i.awaitHandlers)))}async handleChainEnd(e,t,r,a,s){await Promise.all(this.handlers.map(i=>M(async()=>{var o;if(!i.ignoreChain)try{await((o=i.handleChainEnd)==null?void 0:o.call(i,e,this.runId,this._parentRunId,this.tags,s))}catch(u){console.error(`Error in handler ${i.constructor.name}, handleChainEnd: ${u}`)}},i.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>M(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleAgentAction)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){console.error(`Error in handler ${t.constructor.name}, handleAgentAction: ${a}`)}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>M(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleAgentEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){console.error(`Error in handler ${t.constructor.name}, handleAgentEnd: ${a}`)}},t.awaitHandlers)))}}class Va extends kt{getChild(e){const t=new H(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>M(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleToolError)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){console.error(`Error in handler ${t.constructor.name}, handleToolError: ${a}`)}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>M(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleToolEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){console.error(`Error in handler ${t.constructor.name}, handleToolEnd: ${a}`)}},t.awaitHandlers)))}}class H extends Fa{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=(t==null?void 0:t.handlers)??this.handlers,this.inheritableHandlers=(t==null?void 0:t.inheritableHandlers)??this.inheritableHandlers,this.tags=(t==null?void 0:t.tags)??this.tags,this.inheritableTags=(t==null?void 0:t.inheritableTags)??this.inheritableTags,this.metadata=(t==null?void 0:t.metadata)??this.metadata,this.inheritableMetadata=(t==null?void 0:t.inheritableMetadata)??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,r=void 0,a=void 0,s=void 0,i=void 0,o=void 0,u=void 0){return Promise.all(t.map(async c=>{const l=ie();return await Promise.all(this.handlers.map(d=>M(async()=>{var h;if(!d.ignoreLLM)try{await((h=d.handleLLMStart)==null?void 0:h.call(d,e,[c],l,this._parentRunId,s,this.tags,this.metadata,u))}catch(f){console.error(`Error in handler ${d.constructor.name}, handleLLMStart: ${f}`)}},d.awaitHandlers))),new Xr(l,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(e,t,r=void 0,a=void 0,s=void 0,i=void 0,o=void 0,u=void 0){return Promise.all(t.map(async c=>{const l=ie();return await Promise.all(this.handlers.map(d=>M(async()=>{var h,f;if(!d.ignoreLLM)try{if(d.handleChatModelStart)await((h=d.handleChatModelStart)==null?void 0:h.call(d,e,[c],l,this._parentRunId,s,this.tags,this.metadata,u));else if(d.handleLLMStart){const y=Wt(c);await((f=d.handleLLMStart)==null?void 0:f.call(d,e,[y],l,this._parentRunId,s,this.tags,this.metadata,u))}}catch(y){console.error(`Error in handler ${d.constructor.name}, handleLLMStart: ${y}`)}},d.awaitHandlers))),new Xr(l,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(e,t,r=ie(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>M(async()=>{var c;if(!u.ignoreChain)try{await((c=u.handleChainStart)==null?void 0:c.call(u,e,t,r,this._parentRunId,this.tags,this.metadata,a,o))}catch(l){console.error(`Error in handler ${u.constructor.name}, handleChainStart: ${l}`)}},u.awaitHandlers))),new Ha(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,r=ie(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>M(async()=>{var c;if(!u.ignoreAgent)try{await((c=u.handleToolStart)==null?void 0:c.call(u,e,t,r,this._parentRunId,this.tags,this.metadata,o))}catch(l){console.error(`Error in handler ${u.constructor.name}, handleToolStart: ${l}`)}},u.awaitHandlers))),new Va(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,r=ie(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>M(async()=>{var c;if(!u.ignoreRetriever)try{await((c=u.handleRetrieverStart)==null?void 0:c.call(u,e,t,r,this._parentRunId,this.tags,this.metadata,o))}catch(l){console.error(`Error in handler ${u.constructor.name}, handleRetrieverStart: ${l}`)}},u.awaitHandlers))),new za(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(const r of e)this.addHandler(r,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(t=>!e.includes(t)),this.inheritableTags=this.inheritableTags.filter(t=>!e.includes(t))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(const t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){const r=new H(this._parentRunId);for(const a of this.handlers){const s=this.inheritableHandlers.includes(a);r.addHandler(a,s)}for(const a of this.tags){const s=this.inheritableTags.includes(a);r.addTags([a],s)}for(const a of Object.keys(this.metadata)){const s=Object.keys(this.inheritableMetadata).includes(a);r.addMetadata({[a]:this.metadata[a]},s)}for(const a of e)r.handlers.filter(s=>s.name==="console_callback_handler").some(s=>s.name===a.name)||r.addHandler(a,t);return r}static fromHandlers(e){class t extends Ke{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:ie()}),Object.assign(this,e)}}const r=new this;return r.addHandler(new t),r}static async configure(e,t,r,a,s,i,o){let u;(e||t)&&(Array.isArray(e)||!e?(u=new H,u.setHandlers((e==null?void 0:e.map(Tt))??[],!0)):u=e,u=u.copy(Array.isArray(t)?t.map(Tt):t==null?void 0:t.handlers,!1));const c=$e("LANGCHAIN_VERBOSE")==="true"||(o==null?void 0:o.verbose),l=$e("LANGCHAIN_TRACING_V2")==="true",d=l||($e("LANGCHAIN_TRACING")??!1);if(c||d){if(u||(u=new H),c&&!u.handlers.some(h=>h.name===Mr.prototype.name)){const h=new Mr;u.addHandler(h,!0)}d&&!u.handlers.some(h=>h.name==="langchain_tracer")&&l&&u.addHandler(await Za(),!0)}return(r||a)&&u&&(u.addTags(r??[]),u.addTags(a??[],!1)),(s||i)&&u&&(u.addMetadata(s??{}),u.addMetadata(i??{},!1)),u}}function Tt(n){return"name"in n?n:Ke.fromMethods(n)}/*
 * [js-sha1]{@link https://github.com/emn178/js-sha1}
 *
 * @version 0.6.0
 * @author Chen, Yi-Cyuan [emn178@gmail.com]
 * @copyright Chen, Yi-Cyuan 2014-2017
 * @license MIT
 */var Ga=typeof window=="object"?window:{},T="0123456789abcdef".split(""),qa=[-2147483648,8388608,32768,128],ee=[24,16,8,0],L=[];function te(n){n?(L[0]=L[16]=L[1]=L[2]=L[3]=L[4]=L[5]=L[6]=L[7]=L[8]=L[9]=L[10]=L[11]=L[12]=L[13]=L[14]=L[15]=0,this.blocks=L):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}te.prototype.update=function(n){if(!this.finalized){var e=typeof n!="string";e&&n.constructor===Ga.ArrayBuffer&&(n=new Uint8Array(n));for(var t,r=0,a,s=n.length||0,i=this.blocks;r<s;){if(this.hashed&&(this.hashed=!1,i[0]=this.block,i[16]=i[1]=i[2]=i[3]=i[4]=i[5]=i[6]=i[7]=i[8]=i[9]=i[10]=i[11]=i[12]=i[13]=i[14]=i[15]=0),e)for(a=this.start;r<s&&a<64;++r)i[a>>2]|=n[r]<<ee[a++&3];else for(a=this.start;r<s&&a<64;++r)t=n.charCodeAt(r),t<128?i[a>>2]|=t<<ee[a++&3]:t<2048?(i[a>>2]|=(192|t>>6)<<ee[a++&3],i[a>>2]|=(128|t&63)<<ee[a++&3]):t<55296||t>=57344?(i[a>>2]|=(224|t>>12)<<ee[a++&3],i[a>>2]|=(128|t>>6&63)<<ee[a++&3],i[a>>2]|=(128|t&63)<<ee[a++&3]):(t=65536+((t&1023)<<10|n.charCodeAt(++r)&1023),i[a>>2]|=(240|t>>18)<<ee[a++&3],i[a>>2]|=(128|t>>12&63)<<ee[a++&3],i[a>>2]|=(128|t>>6&63)<<ee[a++&3],i[a>>2]|=(128|t&63)<<ee[a++&3]);this.lastByteIndex=a,this.bytes+=a-this.start,a>=64?(this.block=i[16],this.start=a-64,this.hash(),this.hashed=!0):this.start=a}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}},te.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var n=this.blocks,e=this.lastByteIndex;n[16]=this.block,n[e>>2]|=qa[e&3],this.block=n[16],e>=56&&(this.hashed||this.hash(),n[0]=this.block,n[16]=n[1]=n[2]=n[3]=n[4]=n[5]=n[6]=n[7]=n[8]=n[9]=n[10]=n[11]=n[12]=n[13]=n[14]=n[15]=0),n[14]=this.hBytes<<3|this.bytes>>>29,n[15]=this.bytes<<3,this.hash()}},te.prototype.hash=function(){var n=this.h0,e=this.h1,t=this.h2,r=this.h3,a=this.h4,s,i,o,u=this.blocks;for(i=16;i<80;++i)o=u[i-3]^u[i-8]^u[i-14]^u[i-16],u[i]=o<<1|o>>>31;for(i=0;i<20;i+=5)s=e&t|~e&r,o=n<<5|n>>>27,a=o+s+a+1518500249+u[i]<<0,e=e<<30|e>>>2,s=n&e|~n&t,o=a<<5|a>>>27,r=o+s+r+1518500249+u[i+1]<<0,n=n<<30|n>>>2,s=a&n|~a&e,o=r<<5|r>>>27,t=o+s+t+1518500249+u[i+2]<<0,a=a<<30|a>>>2,s=r&a|~r&n,o=t<<5|t>>>27,e=o+s+e+1518500249+u[i+3]<<0,r=r<<30|r>>>2,s=t&r|~t&a,o=e<<5|e>>>27,n=o+s+n+1518500249+u[i+4]<<0,t=t<<30|t>>>2;for(;i<40;i+=5)s=e^t^r,o=n<<5|n>>>27,a=o+s+a+1859775393+u[i]<<0,e=e<<30|e>>>2,s=n^e^t,o=a<<5|a>>>27,r=o+s+r+1859775393+u[i+1]<<0,n=n<<30|n>>>2,s=a^n^e,o=r<<5|r>>>27,t=o+s+t+1859775393+u[i+2]<<0,a=a<<30|a>>>2,s=r^a^n,o=t<<5|t>>>27,e=o+s+e+1859775393+u[i+3]<<0,r=r<<30|r>>>2,s=t^r^a,o=e<<5|e>>>27,n=o+s+n+1859775393+u[i+4]<<0,t=t<<30|t>>>2;for(;i<60;i+=5)s=e&t|e&r|t&r,o=n<<5|n>>>27,a=o+s+a-1894007588+u[i]<<0,e=e<<30|e>>>2,s=n&e|n&t|e&t,o=a<<5|a>>>27,r=o+s+r-1894007588+u[i+1]<<0,n=n<<30|n>>>2,s=a&n|a&e|n&e,o=r<<5|r>>>27,t=o+s+t-1894007588+u[i+2]<<0,a=a<<30|a>>>2,s=r&a|r&n|a&n,o=t<<5|t>>>27,e=o+s+e-1894007588+u[i+3]<<0,r=r<<30|r>>>2,s=t&r|t&a|r&a,o=e<<5|e>>>27,n=o+s+n-1894007588+u[i+4]<<0,t=t<<30|t>>>2;for(;i<80;i+=5)s=e^t^r,o=n<<5|n>>>27,a=o+s+a-899497514+u[i]<<0,e=e<<30|e>>>2,s=n^e^t,o=a<<5|a>>>27,r=o+s+r-899497514+u[i+1]<<0,n=n<<30|n>>>2,s=a^n^e,o=r<<5|r>>>27,t=o+s+t-899497514+u[i+2]<<0,a=a<<30|a>>>2,s=r^a^n,o=t<<5|t>>>27,e=o+s+e-899497514+u[i+3]<<0,r=r<<30|r>>>2,s=t^r^a,o=e<<5|e>>>27,n=o+s+n-899497514+u[i+4]<<0,t=t<<30|t>>>2;this.h0=this.h0+n<<0,this.h1=this.h1+e<<0,this.h2=this.h2+t<<0,this.h3=this.h3+r<<0,this.h4=this.h4+a<<0},te.prototype.hex=function(){this.finalize();var n=this.h0,e=this.h1,t=this.h2,r=this.h3,a=this.h4;return T[n>>28&15]+T[n>>24&15]+T[n>>20&15]+T[n>>16&15]+T[n>>12&15]+T[n>>8&15]+T[n>>4&15]+T[n&15]+T[e>>28&15]+T[e>>24&15]+T[e>>20&15]+T[e>>16&15]+T[e>>12&15]+T[e>>8&15]+T[e>>4&15]+T[e&15]+T[t>>28&15]+T[t>>24&15]+T[t>>20&15]+T[t>>16&15]+T[t>>12&15]+T[t>>8&15]+T[t>>4&15]+T[t&15]+T[r>>28&15]+T[r>>24&15]+T[r>>20&15]+T[r>>16&15]+T[r>>12&15]+T[r>>8&15]+T[r>>4&15]+T[r&15]+T[a>>28&15]+T[a>>24&15]+T[a>>20&15]+T[a>>16&15]+T[a>>12&15]+T[a>>8&15]+T[a>>4&15]+T[a&15]},te.prototype.toString=te.prototype.hex,te.prototype.digest=function(){this.finalize();var n=this.h0,e=this.h1,t=this.h2,r=this.h3,a=this.h4;return[n>>24&255,n>>16&255,n>>8&255,n&255,e>>24&255,e>>16&255,e>>8&255,e&255,t>>24&255,t>>16&255,t>>8&255,t&255,r>>24&255,r>>16&255,r>>8&255,r&255,a>>24&255,a>>16&255,a>>8&255,a&255]},te.prototype.array=te.prototype.digest,te.prototype.arrayBuffer=function(){this.finalize();var n=new ArrayBuffer(20),e=new DataView(n);return e.setUint32(0,this.h0),e.setUint32(4,this.h1),e.setUint32(8,this.h2),e.setUint32(12,this.h3),e.setUint32(16,this.h4),n};const Ja=n=>new te(!0).update(n).hex(),en=(...n)=>Ja(n.join("_"));class Wa{}const Ka=new Map;class or extends Wa{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(en(e,t))??null)}async update(e,t,r){this.cache.set(en(e,t),r)}static global(){return new or(Ka)}}class tn extends Ee{}class Qa extends tn{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new zt(this.value)]}}class Ya extends tn{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return Wt(this.messages)}toChatMessages(){return this.messages}}const Xa=[400,401,402,403,404,405,406,407,409],es=n=>{var t,r;if(n.message.startsWith("Cancel")||n.message.startsWith("AbortError")||n.name==="AbortError"||(n==null?void 0:n.code)==="ECONNABORTED")throw n;const e=((t=n==null?void 0:n.response)==null?void 0:t.status)??(n==null?void 0:n.status);if(e&&Xa.includes(+e))throw n;if(((r=n==null?void 0:n.error)==null?void 0:r.code)==="insufficient_quota"){const a=new Error(n==null?void 0:n.message);throw a.name="InsufficientQuotaError",a}};class ur{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??es;const t="default"in he?he.default:he;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>vt(()=>e(...t).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((a,s)=>{var i;(i=e.signal)==null||i.addEventListener("abort",()=>{s(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}}var Ot={};Ot.byteLength=ns,Ot.toByteArray=ss,Ot.fromByteArray=us;for(var oe=[],K=[],ts=typeof Uint8Array<"u"?Uint8Array:Array,cr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Le=0,rs=cr.length;Le<rs;++Le)oe[Le]=cr[Le],K[cr.charCodeAt(Le)]=Le;K[45]=62,K[95]=63;function rn(n){var e=n.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=n.indexOf("=");t===-1&&(t=e);var r=t===e?0:4-t%4;return[t,r]}function ns(n){var e=rn(n),t=e[0],r=e[1];return(t+r)*3/4-r}function as(n,e,t){return(e+t)*3/4-t}function ss(n){var e,t=rn(n),r=t[0],a=t[1],s=new ts(as(n,r,a)),i=0,o=a>0?r-4:r,u;for(u=0;u<o;u+=4)e=K[n.charCodeAt(u)]<<18|K[n.charCodeAt(u+1)]<<12|K[n.charCodeAt(u+2)]<<6|K[n.charCodeAt(u+3)],s[i++]=e>>16&255,s[i++]=e>>8&255,s[i++]=e&255;return a===2&&(e=K[n.charCodeAt(u)]<<2|K[n.charCodeAt(u+1)]>>4,s[i++]=e&255),a===1&&(e=K[n.charCodeAt(u)]<<10|K[n.charCodeAt(u+1)]<<4|K[n.charCodeAt(u+2)]>>2,s[i++]=e>>8&255,s[i++]=e&255),s}function is(n){return oe[n>>18&63]+oe[n>>12&63]+oe[n>>6&63]+oe[n&63]}function os(n,e,t){for(var r,a=[],s=e;s<t;s+=3)r=(n[s]<<16&16711680)+(n[s+1]<<8&65280)+(n[s+2]&255),a.push(is(r));return a.join("")}function us(n){for(var e,t=n.length,r=t%3,a=[],s=16383,i=0,o=t-r;i<o;i+=s)a.push(os(n,i,i+s>o?o:i+s));return r===1?(e=n[t-1],a.push(oe[e>>2]+oe[e<<4&63]+"==")):r===2&&(e=(n[t-2]<<8)+n[t-1],a.push(oe[e>>10]+oe[e>>4&63]+oe[e<<2&63]+"=")),a.join("")}var cs=Object.defineProperty,ls=(n,e,t)=>e in n?cs(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,ds=(n,e,t)=>(ls(n,typeof e!="symbol"?e+"":e,t),t);function hs(n,e){let t=Array.from({length:n.length},(r,a)=>({start:a,end:a+1}));for(;t.length>1;){let r=null;for(let a=0;a<t.length-1;a++){const s=n.slice(t[a].start,t[a+1].end),i=e.get(s.join(","));i!=null&&(r==null||i<r[0])&&(r=[i,a])}if(r!=null){const a=r[1];t[a]={start:t[a].start,end:t[a+1].end},t.splice(a+1,1)}else break}return t}function fs(n,e){return n.length===1?[e.get(n.join(","))]:hs(n,e).map(t=>e.get(n.slice(t.start,t.end).join(","))).filter(t=>t!=null)}function ps(n){return n.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}var lr=class{constructor(n,e){Oe(this,"specialTokens");Oe(this,"inverseSpecialTokens");Oe(this,"patStr");Oe(this,"textEncoder",new TextEncoder);Oe(this,"textDecoder",new TextDecoder("utf-8"));Oe(this,"rankMap",new Map);Oe(this,"textMap",new Map);this.patStr=n.pat_str;const t=n.bpe_ranks.split(`
`).filter(Boolean).reduce((r,a)=>{const[s,i,...o]=a.split(" "),u=Number.parseInt(i,10);return o.forEach((c,l)=>r[c]=u+l),r},{});for(const[r,a]of Object.entries(t)){const s=Ot.toByteArray(r);this.rankMap.set(s.join(","),a),this.textMap.set(a,s)}this.specialTokens={...n.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((r,[a,s])=>(r[s]=this.textEncoder.encode(a),r),{})}encode(n,e=[],t="all"){const r=new RegExp(this.patStr,"ug"),a=lr.specialTokenRegex(Object.keys(this.specialTokens)),s=[],i=new Set(e==="all"?Object.keys(this.specialTokens):e),o=new Set(t==="all"?Object.keys(this.specialTokens).filter(c=>!i.has(c)):t);if(o.size>0){const c=lr.specialTokenRegex([...o]),l=n.match(c);if(l!=null)throw new Error(`The text contains a special token that is not allowed: ${l[0]}`)}let u=0;for(;;){let c=null,l=u;for(;a.lastIndex=l,c=a.exec(n),!(c==null||i.has(c[0]));)l=c.index+1;const d=(c==null?void 0:c.index)??n.length;for(const f of n.substring(u,d).matchAll(r)){const y=this.textEncoder.encode(f[0]),w=this.rankMap.get(y.join(","));if(w!=null){s.push(w);continue}s.push(...fs(y,this.rankMap))}if(c==null)break;let h=this.specialTokens[c[0]];s.push(h),u=c.index+c[0].length}return s}decode(n){const e=[];let t=0;for(let s=0;s<n.length;++s){const i=n[s],o=this.textMap.get(i)??this.inverseSpecialTokens[i];o!=null&&(e.push(o),t+=o.length)}const r=new Uint8Array(t);let a=0;for(const s of e)r.set(s,a),a+=s.length;return this.textDecoder.decode(r)}},nn=lr;ds(nn,"specialTokenRegex",n=>new RegExp(n.map(e=>ps(e)).join("|"),"g"));function ms(n){switch(n){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":return"cl100k_base";default:throw new Error("Unknown model")}}const Et={},ys=new ur({});async function gs(n){return n in Et||(Et[n]=ys.fetch(`https://tiktoken.pages.dev/js/${n}.json`).then(e=>e.json()).then(e=>new nn(e)).catch(e=>{throw delete Et[n],e})),await Et[n]}async function bs(n){return gs(ms(n))}var P;(function(n){n.assertEqual=a=>a;function e(a){}n.assertIs=e;function t(a){throw new Error}n.assertNever=t,n.arrayToEnum=a=>{const s={};for(const i of a)s[i]=i;return s},n.getValidEnumValues=a=>{const s=n.objectKeys(a).filter(o=>typeof a[a[o]]!="number"),i={};for(const o of s)i[o]=a[o];return n.objectValues(i)},n.objectValues=a=>n.objectKeys(a).map(function(s){return a[s]}),n.objectKeys=typeof Object.keys=="function"?a=>Object.keys(a):a=>{const s=[];for(const i in a)Object.prototype.hasOwnProperty.call(a,i)&&s.push(i);return s},n.find=(a,s)=>{for(const i of a)if(s(i))return i},n.isInteger=typeof Number.isInteger=="function"?a=>Number.isInteger(a):a=>typeof a=="number"&&isFinite(a)&&Math.floor(a)===a;function r(a,s=" | "){return a.map(i=>typeof i=="string"?`'${i}'`:i).join(s)}n.joinValues=r,n.jsonStringifyReplacer=(a,s)=>typeof s=="bigint"?s.toString():s})(P||(P={}));var dr;(function(n){n.mergeShapes=(e,t)=>({...e,...t})})(dr||(dr={}));const g=P.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),ve=n=>{switch(typeof n){case"undefined":return g.undefined;case"string":return g.string;case"number":return isNaN(n)?g.nan:g.number;case"boolean":return g.boolean;case"function":return g.function;case"bigint":return g.bigint;case"symbol":return g.symbol;case"object":return Array.isArray(n)?g.array:n===null?g.null:n.then&&typeof n.then=="function"&&n.catch&&typeof n.catch=="function"?g.promise:typeof Map<"u"&&n instanceof Map?g.map:typeof Set<"u"&&n instanceof Set?g.set:typeof Date<"u"&&n instanceof Date?g.date:g.object;default:return g.unknown}},m=P.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]),_s=n=>JSON.stringify(n,null,2).replace(/"([^"]+)":/g,"$1:");class re extends Error{constructor(e){super(),this.issues=[],this.addIssue=r=>{this.issues=[...this.issues,r]},this.addIssues=(r=[])=>{this.issues=[...this.issues,...r]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}get errors(){return this.issues}format(e){const t=e||function(s){return s.message},r={_errors:[]},a=s=>{for(const i of s.issues)if(i.code==="invalid_union")i.unionErrors.map(a);else if(i.code==="invalid_return_type")a(i.returnTypeError);else if(i.code==="invalid_arguments")a(i.argumentsError);else if(i.path.length===0)r._errors.push(t(i));else{let o=r,u=0;for(;u<i.path.length;){const c=i.path[u];u===i.path.length-1?(o[c]=o[c]||{_errors:[]},o[c]._errors.push(t(i))):o[c]=o[c]||{_errors:[]},o=o[c],u++}}};return a(this),r}toString(){return this.message}get message(){return JSON.stringify(this.issues,P.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=t=>t.message){const t={},r=[];for(const a of this.issues)a.path.length>0?(t[a.path[0]]=t[a.path[0]]||[],t[a.path[0]].push(e(a))):r.push(e(a));return{formErrors:r,fieldErrors:t}}get formErrors(){return this.flatten()}}re.create=n=>new re(n);const Ye=(n,e)=>{let t;switch(n.code){case m.invalid_type:n.received===g.undefined?t="Required":t=`Expected ${n.expected}, received ${n.received}`;break;case m.invalid_literal:t=`Invalid literal value, expected ${JSON.stringify(n.expected,P.jsonStringifyReplacer)}`;break;case m.unrecognized_keys:t=`Unrecognized key(s) in object: ${P.joinValues(n.keys,", ")}`;break;case m.invalid_union:t="Invalid input";break;case m.invalid_union_discriminator:t=`Invalid discriminator value. Expected ${P.joinValues(n.options)}`;break;case m.invalid_enum_value:t=`Invalid enum value. Expected ${P.joinValues(n.options)}, received '${n.received}'`;break;case m.invalid_arguments:t="Invalid function arguments";break;case m.invalid_return_type:t="Invalid function return type";break;case m.invalid_date:t="Invalid date";break;case m.invalid_string:typeof n.validation=="object"?"includes"in n.validation?(t=`Invalid input: must include "${n.validation.includes}"`,typeof n.validation.position=="number"&&(t=`${t} at one or more positions greater than or equal to ${n.validation.position}`)):"startsWith"in n.validation?t=`Invalid input: must start with "${n.validation.startsWith}"`:"endsWith"in n.validation?t=`Invalid input: must end with "${n.validation.endsWith}"`:P.assertNever(n.validation):n.validation!=="regex"?t=`Invalid ${n.validation}`:t="Invalid";break;case m.too_small:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at least":"more than"} ${n.minimum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at least":"over"} ${n.minimum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${n.minimum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(n.minimum))}`:t="Invalid input";break;case m.too_big:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at most":"less than"} ${n.maximum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at most":"under"} ${n.maximum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="bigint"?t=`BigInt must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly":n.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(n.maximum))}`:t="Invalid input";break;case m.custom:t="Invalid input";break;case m.invalid_intersection_types:t="Intersection results could not be merged";break;case m.not_multiple_of:t=`Number must be a multiple of ${n.multipleOf}`;break;case m.not_finite:t="Number must be finite";break;default:t=e.defaultError,P.assertNever(n)}return{message:t}};let an=Ye;function vs(n){an=n}function Pt(){return an}const St=n=>{const{data:e,path:t,errorMaps:r,issueData:a}=n,s=[...t,...a.path||[]],i={...a,path:s};let o="";const u=r.filter(c=>!!c).slice().reverse();for(const c of u)o=c(i,{data:e,defaultError:o}).message;return{...a,path:s,message:a.message||o}},ws=[];function b(n,e){const t=St({issueData:e,data:n.data,path:n.path,errorMaps:[n.common.contextualErrorMap,n.schemaErrorMap,Pt(),Ye].filter(r=>!!r)});n.common.issues.push(t)}class U{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,t){const r=[];for(const a of t){if(a.status==="aborted")return x;a.status==="dirty"&&e.dirty(),r.push(a.value)}return{status:e.value,value:r}}static async mergeObjectAsync(e,t){const r=[];for(const a of t)r.push({key:await a.key,value:await a.value});return U.mergeObjectSync(e,r)}static mergeObjectSync(e,t){const r={};for(const a of t){const{key:s,value:i}=a;if(s.status==="aborted"||i.status==="aborted")return x;s.status==="dirty"&&e.dirty(),i.status==="dirty"&&e.dirty(),s.value!=="__proto__"&&(typeof i.value<"u"||a.alwaysSet)&&(r[s.value]=i.value)}return{status:e.value,value:r}}}const x=Object.freeze({status:"aborted"}),sn=n=>({status:"dirty",value:n}),F=n=>({status:"valid",value:n}),hr=n=>n.status==="aborted",fr=n=>n.status==="dirty",Xe=n=>n.status==="valid",At=n=>typeof Promise<"u"&&n instanceof Promise;var v;(function(n){n.errToObj=e=>typeof e=="string"?{message:e}:e||{},n.toString=e=>typeof e=="string"?e:e==null?void 0:e.message})(v||(v={}));class ue{constructor(e,t,r,a){this._cachedPath=[],this.parent=e,this.data=t,this._path=r,this._key=a}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const on=(n,e)=>{if(Xe(e))return{success:!0,data:e.value};if(!n.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new re(n.common.issues);return this._error=t,this._error}}};function k(n){if(!n)return{};const{errorMap:e,invalid_type_error:t,required_error:r,description:a}=n;if(e&&(t||r))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:a}:{errorMap:(i,o)=>i.code!=="invalid_type"?{message:o.defaultError}:typeof o.data>"u"?{message:r??o.defaultError}:{message:t??o.defaultError},description:a}}class O{constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this)}get description(){return this._def.description}_getType(e){return ve(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:ve(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new U,ctx:{common:e.parent.common,data:e.data,parsedType:ve(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(At(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const r=this.safeParse(e,t);if(r.success)return r.data;throw r.error}safeParse(e,t){var r;const a={common:{issues:[],async:(r=t==null?void 0:t.async)!==null&&r!==void 0?r:!1,contextualErrorMap:t==null?void 0:t.errorMap},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:ve(e)},s=this._parseSync({data:e,path:a.path,parent:a});return on(a,s)}async parseAsync(e,t){const r=await this.safeParseAsync(e,t);if(r.success)return r.data;throw r.error}async safeParseAsync(e,t){const r={common:{issues:[],contextualErrorMap:t==null?void 0:t.errorMap,async:!0},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:ve(e)},a=this._parse({data:e,path:r.path,parent:r}),s=await(At(a)?a:Promise.resolve(a));return on(r,s)}refine(e,t){const r=a=>typeof t=="string"||typeof t>"u"?{message:t}:typeof t=="function"?t(a):t;return this._refinement((a,s)=>{const i=e(a),o=()=>s.addIssue({code:m.custom,...r(a)});return typeof Promise<"u"&&i instanceof Promise?i.then(u=>u?!0:(o(),!1)):i?!0:(o(),!1)})}refinement(e,t){return this._refinement((r,a)=>e(r)?!0:(a.addIssue(typeof t=="function"?t(r,a):t),!1))}_refinement(e){return new se({schema:this,typeName:p.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}optional(){return me.create(this,this._def)}nullable(){return Ie.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return ae.create(this,this._def)}promise(){return Ze.create(this,this._def)}or(e){return nt.create([this,e],this._def)}and(e){return at.create(this,e,this._def)}transform(e){return new se({...k(this._def),schema:this,typeName:p.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t=typeof e=="function"?e:()=>e;return new ct({...k(this._def),innerType:this,defaultValue:t,typeName:p.ZodDefault})}brand(){return new cn({typeName:p.ZodBranded,type:this,...k(this._def)})}catch(e){const t=typeof e=="function"?e:()=>e;return new $t({...k(this._def),innerType:this,catchValue:t,typeName:p.ZodCatch})}describe(e){const t=this.constructor;return new t({...this._def,description:e})}pipe(e){return lt.create(this,e)}readonly(){return Dt.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const xs=/^c[^\s-]{8,}$/i,ks=/^[a-z][a-z0-9]*$/,Ts=/^[0-9A-HJKMNP-TV-Z]{26}$/,Os=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,Es=/^(?!\.)(?!.*\.\.)([A-Z0-9_+-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,Ps="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";let pr;const Ss=/^(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))$/,As=/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,Cs=n=>n.precision?n.offset?new RegExp(`^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d{${n.precision}}(([+-]\\d{2}(:?\\d{2})?)|Z)$`):new RegExp(`^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d{${n.precision}}Z$`):n.precision===0?n.offset?new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(([+-]\\d{2}(:?\\d{2})?)|Z)$"):new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}Z$"):n.offset?new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d+)?(([+-]\\d{2}(:?\\d{2})?)|Z)$"):new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d+)?Z$");function Is(n,e){return!!((e==="v4"||!e)&&Ss.test(n)||(e==="v6"||!e)&&As.test(n))}class ne extends O{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==g.string){const s=this._getOrReturnCtx(e);return b(s,{code:m.invalid_type,expected:g.string,received:s.parsedType}),x}const r=new U;let a;for(const s of this._def.checks)if(s.kind==="min")e.data.length<s.value&&(a=this._getOrReturnCtx(e,a),b(a,{code:m.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),r.dirty());else if(s.kind==="max")e.data.length>s.value&&(a=this._getOrReturnCtx(e,a),b(a,{code:m.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),r.dirty());else if(s.kind==="length"){const i=e.data.length>s.value,o=e.data.length<s.value;(i||o)&&(a=this._getOrReturnCtx(e,a),i?b(a,{code:m.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}):o&&b(a,{code:m.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}),r.dirty())}else if(s.kind==="email")Es.test(e.data)||(a=this._getOrReturnCtx(e,a),b(a,{validation:"email",code:m.invalid_string,message:s.message}),r.dirty());else if(s.kind==="emoji")pr||(pr=new RegExp(Ps,"u")),pr.test(e.data)||(a=this._getOrReturnCtx(e,a),b(a,{validation:"emoji",code:m.invalid_string,message:s.message}),r.dirty());else if(s.kind==="uuid")Os.test(e.data)||(a=this._getOrReturnCtx(e,a),b(a,{validation:"uuid",code:m.invalid_string,message:s.message}),r.dirty());else if(s.kind==="cuid")xs.test(e.data)||(a=this._getOrReturnCtx(e,a),b(a,{validation:"cuid",code:m.invalid_string,message:s.message}),r.dirty());else if(s.kind==="cuid2")ks.test(e.data)||(a=this._getOrReturnCtx(e,a),b(a,{validation:"cuid2",code:m.invalid_string,message:s.message}),r.dirty());else if(s.kind==="ulid")Ts.test(e.data)||(a=this._getOrReturnCtx(e,a),b(a,{validation:"ulid",code:m.invalid_string,message:s.message}),r.dirty());else if(s.kind==="url")try{new URL(e.data)}catch{a=this._getOrReturnCtx(e,a),b(a,{validation:"url",code:m.invalid_string,message:s.message}),r.dirty()}else s.kind==="regex"?(s.regex.lastIndex=0,s.regex.test(e.data)||(a=this._getOrReturnCtx(e,a),b(a,{validation:"regex",code:m.invalid_string,message:s.message}),r.dirty())):s.kind==="trim"?e.data=e.data.trim():s.kind==="includes"?e.data.includes(s.value,s.position)||(a=this._getOrReturnCtx(e,a),b(a,{code:m.invalid_string,validation:{includes:s.value,position:s.position},message:s.message}),r.dirty()):s.kind==="toLowerCase"?e.data=e.data.toLowerCase():s.kind==="toUpperCase"?e.data=e.data.toUpperCase():s.kind==="startsWith"?e.data.startsWith(s.value)||(a=this._getOrReturnCtx(e,a),b(a,{code:m.invalid_string,validation:{startsWith:s.value},message:s.message}),r.dirty()):s.kind==="endsWith"?e.data.endsWith(s.value)||(a=this._getOrReturnCtx(e,a),b(a,{code:m.invalid_string,validation:{endsWith:s.value},message:s.message}),r.dirty()):s.kind==="datetime"?Cs(s).test(e.data)||(a=this._getOrReturnCtx(e,a),b(a,{code:m.invalid_string,validation:"datetime",message:s.message}),r.dirty()):s.kind==="ip"?Is(e.data,s.version)||(a=this._getOrReturnCtx(e,a),b(a,{validation:"ip",code:m.invalid_string,message:s.message}),r.dirty()):P.assertNever(s);return{status:r.value,value:e.data}}_regex(e,t,r){return this.refinement(a=>e.test(a),{validation:t,code:m.invalid_string,...v.errToObj(r)})}_addCheck(e){return new ne({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...v.errToObj(e)})}url(e){return this._addCheck({kind:"url",...v.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...v.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...v.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...v.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...v.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...v.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...v.errToObj(e)})}datetime(e){var t;return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,offset:(t=e==null?void 0:e.offset)!==null&&t!==void 0?t:!1,...v.errToObj(e==null?void 0:e.message)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...v.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t==null?void 0:t.position,...v.errToObj(t==null?void 0:t.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...v.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...v.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...v.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...v.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...v.errToObj(t)})}nonempty(e){return this.min(1,v.errToObj(e))}trim(){return new ne({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new ne({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new ne({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get minLength(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}ne.create=n=>{var e;return new ne({checks:[],typeName:p.ZodString,coerce:(e=n==null?void 0:n.coerce)!==null&&e!==void 0?e:!1,...k(n)})};function Rs(n,e){const t=(n.toString().split(".")[1]||"").length,r=(e.toString().split(".")[1]||"").length,a=t>r?t:r,s=parseInt(n.toFixed(a).replace(".","")),i=parseInt(e.toFixed(a).replace(".",""));return s%i/Math.pow(10,a)}class we extends O{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==g.number){const s=this._getOrReturnCtx(e);return b(s,{code:m.invalid_type,expected:g.number,received:s.parsedType}),x}let r;const a=new U;for(const s of this._def.checks)s.kind==="int"?P.isInteger(e.data)||(r=this._getOrReturnCtx(e,r),b(r,{code:m.invalid_type,expected:"integer",received:"float",message:s.message}),a.dirty()):s.kind==="min"?(s.inclusive?e.data<s.value:e.data<=s.value)&&(r=this._getOrReturnCtx(e,r),b(r,{code:m.too_small,minimum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),a.dirty()):s.kind==="max"?(s.inclusive?e.data>s.value:e.data>=s.value)&&(r=this._getOrReturnCtx(e,r),b(r,{code:m.too_big,maximum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),a.dirty()):s.kind==="multipleOf"?Rs(e.data,s.value)!==0&&(r=this._getOrReturnCtx(e,r),b(r,{code:m.not_multiple_of,multipleOf:s.value,message:s.message}),a.dirty()):s.kind==="finite"?Number.isFinite(e.data)||(r=this._getOrReturnCtx(e,r),b(r,{code:m.not_finite,message:s.message}),a.dirty()):P.assertNever(s);return{status:a.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,v.toString(t))}gt(e,t){return this.setLimit("min",e,!1,v.toString(t))}lte(e,t){return this.setLimit("max",e,!0,v.toString(t))}lt(e,t){return this.setLimit("max",e,!1,v.toString(t))}setLimit(e,t,r,a){return new we({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:v.toString(a)}]})}_addCheck(e){return new we({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:v.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:v.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:v.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:v.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:v.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:v.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:v.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:v.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:v.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&P.isInteger(e.value))}get isFinite(){let e=null,t=null;for(const r of this._def.checks){if(r.kind==="finite"||r.kind==="int"||r.kind==="multipleOf")return!0;r.kind==="min"?(t===null||r.value>t)&&(t=r.value):r.kind==="max"&&(e===null||r.value<e)&&(e=r.value)}return Number.isFinite(t)&&Number.isFinite(e)}}we.create=n=>new we({checks:[],typeName:p.ZodNumber,coerce:(n==null?void 0:n.coerce)||!1,...k(n)});class xe extends O{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce&&(e.data=BigInt(e.data)),this._getType(e)!==g.bigint){const s=this._getOrReturnCtx(e);return b(s,{code:m.invalid_type,expected:g.bigint,received:s.parsedType}),x}let r;const a=new U;for(const s of this._def.checks)s.kind==="min"?(s.inclusive?e.data<s.value:e.data<=s.value)&&(r=this._getOrReturnCtx(e,r),b(r,{code:m.too_small,type:"bigint",minimum:s.value,inclusive:s.inclusive,message:s.message}),a.dirty()):s.kind==="max"?(s.inclusive?e.data>s.value:e.data>=s.value)&&(r=this._getOrReturnCtx(e,r),b(r,{code:m.too_big,type:"bigint",maximum:s.value,inclusive:s.inclusive,message:s.message}),a.dirty()):s.kind==="multipleOf"?e.data%s.value!==BigInt(0)&&(r=this._getOrReturnCtx(e,r),b(r,{code:m.not_multiple_of,multipleOf:s.value,message:s.message}),a.dirty()):P.assertNever(s);return{status:a.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,v.toString(t))}gt(e,t){return this.setLimit("min",e,!1,v.toString(t))}lte(e,t){return this.setLimit("max",e,!0,v.toString(t))}lt(e,t){return this.setLimit("max",e,!1,v.toString(t))}setLimit(e,t,r,a){return new xe({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:v.toString(a)}]})}_addCheck(e){return new xe({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:v.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:v.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:v.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:v.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:v.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}xe.create=n=>{var e;return new xe({checks:[],typeName:p.ZodBigInt,coerce:(e=n==null?void 0:n.coerce)!==null&&e!==void 0?e:!1,...k(n)})};class et extends O{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==g.boolean){const r=this._getOrReturnCtx(e);return b(r,{code:m.invalid_type,expected:g.boolean,received:r.parsedType}),x}return F(e.data)}}et.create=n=>new et({typeName:p.ZodBoolean,coerce:(n==null?void 0:n.coerce)||!1,...k(n)});class Se extends O{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==g.date){const s=this._getOrReturnCtx(e);return b(s,{code:m.invalid_type,expected:g.date,received:s.parsedType}),x}if(isNaN(e.data.getTime())){const s=this._getOrReturnCtx(e);return b(s,{code:m.invalid_date}),x}const r=new U;let a;for(const s of this._def.checks)s.kind==="min"?e.data.getTime()<s.value&&(a=this._getOrReturnCtx(e,a),b(a,{code:m.too_small,message:s.message,inclusive:!0,exact:!1,minimum:s.value,type:"date"}),r.dirty()):s.kind==="max"?e.data.getTime()>s.value&&(a=this._getOrReturnCtx(e,a),b(a,{code:m.too_big,message:s.message,inclusive:!0,exact:!1,maximum:s.value,type:"date"}),r.dirty()):P.assertNever(s);return{status:r.value,value:new Date(e.data.getTime())}}_addCheck(e){return new Se({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:v.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:v.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e!=null?new Date(e):null}}Se.create=n=>new Se({checks:[],coerce:(n==null?void 0:n.coerce)||!1,typeName:p.ZodDate,...k(n)});class Ct extends O{_parse(e){if(this._getType(e)!==g.symbol){const r=this._getOrReturnCtx(e);return b(r,{code:m.invalid_type,expected:g.symbol,received:r.parsedType}),x}return F(e.data)}}Ct.create=n=>new Ct({typeName:p.ZodSymbol,...k(n)});class tt extends O{_parse(e){if(this._getType(e)!==g.undefined){const r=this._getOrReturnCtx(e);return b(r,{code:m.invalid_type,expected:g.undefined,received:r.parsedType}),x}return F(e.data)}}tt.create=n=>new tt({typeName:p.ZodUndefined,...k(n)});class rt extends O{_parse(e){if(this._getType(e)!==g.null){const r=this._getOrReturnCtx(e);return b(r,{code:m.invalid_type,expected:g.null,received:r.parsedType}),x}return F(e.data)}}rt.create=n=>new rt({typeName:p.ZodNull,...k(n)});class De extends O{constructor(){super(...arguments),this._any=!0}_parse(e){return F(e.data)}}De.create=n=>new De({typeName:p.ZodAny,...k(n)});class Ae extends O{constructor(){super(...arguments),this._unknown=!0}_parse(e){return F(e.data)}}Ae.create=n=>new Ae({typeName:p.ZodUnknown,...k(n)});class pe extends O{_parse(e){const t=this._getOrReturnCtx(e);return b(t,{code:m.invalid_type,expected:g.never,received:t.parsedType}),x}}pe.create=n=>new pe({typeName:p.ZodNever,...k(n)});class It extends O{_parse(e){if(this._getType(e)!==g.undefined){const r=this._getOrReturnCtx(e);return b(r,{code:m.invalid_type,expected:g.void,received:r.parsedType}),x}return F(e.data)}}It.create=n=>new It({typeName:p.ZodVoid,...k(n)});class ae extends O{_parse(e){const{ctx:t,status:r}=this._processInputParams(e),a=this._def;if(t.parsedType!==g.array)return b(t,{code:m.invalid_type,expected:g.array,received:t.parsedType}),x;if(a.exactLength!==null){const i=t.data.length>a.exactLength.value,o=t.data.length<a.exactLength.value;(i||o)&&(b(t,{code:i?m.too_big:m.too_small,minimum:o?a.exactLength.value:void 0,maximum:i?a.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:a.exactLength.message}),r.dirty())}if(a.minLength!==null&&t.data.length<a.minLength.value&&(b(t,{code:m.too_small,minimum:a.minLength.value,type:"array",inclusive:!0,exact:!1,message:a.minLength.message}),r.dirty()),a.maxLength!==null&&t.data.length>a.maxLength.value&&(b(t,{code:m.too_big,maximum:a.maxLength.value,type:"array",inclusive:!0,exact:!1,message:a.maxLength.message}),r.dirty()),t.common.async)return Promise.all([...t.data].map((i,o)=>a.type._parseAsync(new ue(t,i,t.path,o)))).then(i=>U.mergeArray(r,i));const s=[...t.data].map((i,o)=>a.type._parseSync(new ue(t,i,t.path,o)));return U.mergeArray(r,s)}get element(){return this._def.type}min(e,t){return new ae({...this._def,minLength:{value:e,message:v.toString(t)}})}max(e,t){return new ae({...this._def,maxLength:{value:e,message:v.toString(t)}})}length(e,t){return new ae({...this._def,exactLength:{value:e,message:v.toString(t)}})}nonempty(e){return this.min(1,e)}}ae.create=(n,e)=>new ae({type:n,minLength:null,maxLength:null,exactLength:null,typeName:p.ZodArray,...k(e)});function Me(n){if(n instanceof j){const e={};for(const t in n.shape){const r=n.shape[t];e[t]=me.create(Me(r))}return new j({...n._def,shape:()=>e})}else return n instanceof ae?new ae({...n._def,type:Me(n.element)}):n instanceof me?me.create(Me(n.unwrap())):n instanceof Ie?Ie.create(Me(n.unwrap())):n instanceof ce?ce.create(n.items.map(e=>Me(e))):n}class j extends O{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const e=this._def.shape(),t=P.objectKeys(e);return this._cached={shape:e,keys:t}}_parse(e){if(this._getType(e)!==g.object){const c=this._getOrReturnCtx(e);return b(c,{code:m.invalid_type,expected:g.object,received:c.parsedType}),x}const{status:r,ctx:a}=this._processInputParams(e),{shape:s,keys:i}=this._getCached(),o=[];if(!(this._def.catchall instanceof pe&&this._def.unknownKeys==="strip"))for(const c in a.data)i.includes(c)||o.push(c);const u=[];for(const c of i){const l=s[c],d=a.data[c];u.push({key:{status:"valid",value:c},value:l._parse(new ue(a,d,a.path,c)),alwaysSet:c in a.data})}if(this._def.catchall instanceof pe){const c=this._def.unknownKeys;if(c==="passthrough")for(const l of o)u.push({key:{status:"valid",value:l},value:{status:"valid",value:a.data[l]}});else if(c==="strict")o.length>0&&(b(a,{code:m.unrecognized_keys,keys:o}),r.dirty());else if(c!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const c=this._def.catchall;for(const l of o){const d=a.data[l];u.push({key:{status:"valid",value:l},value:c._parse(new ue(a,d,a.path,l)),alwaysSet:l in a.data})}}return a.common.async?Promise.resolve().then(async()=>{const c=[];for(const l of u){const d=await l.key;c.push({key:d,value:await l.value,alwaysSet:l.alwaysSet})}return c}).then(c=>U.mergeObjectSync(r,c)):U.mergeObjectSync(r,u)}get shape(){return this._def.shape()}strict(e){return v.errToObj,new j({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(t,r)=>{var a,s,i,o;const u=(i=(s=(a=this._def).errorMap)===null||s===void 0?void 0:s.call(a,t,r).message)!==null&&i!==void 0?i:r.defaultError;return t.code==="unrecognized_keys"?{message:(o=v.errToObj(e).message)!==null&&o!==void 0?o:u}:{message:u}}}:{}})}strip(){return new j({...this._def,unknownKeys:"strip"})}passthrough(){return new j({...this._def,unknownKeys:"passthrough"})}extend(e){return new j({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new j({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:p.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new j({...this._def,catchall:e})}pick(e){const t={};return P.objectKeys(e).forEach(r=>{e[r]&&this.shape[r]&&(t[r]=this.shape[r])}),new j({...this._def,shape:()=>t})}omit(e){const t={};return P.objectKeys(this.shape).forEach(r=>{e[r]||(t[r]=this.shape[r])}),new j({...this._def,shape:()=>t})}deepPartial(){return Me(this)}partial(e){const t={};return P.objectKeys(this.shape).forEach(r=>{const a=this.shape[r];e&&!e[r]?t[r]=a:t[r]=a.optional()}),new j({...this._def,shape:()=>t})}required(e){const t={};return P.objectKeys(this.shape).forEach(r=>{if(e&&!e[r])t[r]=this.shape[r];else{let s=this.shape[r];for(;s instanceof me;)s=s._def.innerType;t[r]=s}}),new j({...this._def,shape:()=>t})}keyof(){return un(P.objectKeys(this.shape))}}j.create=(n,e)=>new j({shape:()=>n,unknownKeys:"strip",catchall:pe.create(),typeName:p.ZodObject,...k(e)}),j.strictCreate=(n,e)=>new j({shape:()=>n,unknownKeys:"strict",catchall:pe.create(),typeName:p.ZodObject,...k(e)}),j.lazycreate=(n,e)=>new j({shape:n,unknownKeys:"strip",catchall:pe.create(),typeName:p.ZodObject,...k(e)});class nt extends O{_parse(e){const{ctx:t}=this._processInputParams(e),r=this._def.options;function a(s){for(const o of s)if(o.result.status==="valid")return o.result;for(const o of s)if(o.result.status==="dirty")return t.common.issues.push(...o.ctx.common.issues),o.result;const i=s.map(o=>new re(o.ctx.common.issues));return b(t,{code:m.invalid_union,unionErrors:i}),x}if(t.common.async)return Promise.all(r.map(async s=>{const i={...t,common:{...t.common,issues:[]},parent:null};return{result:await s._parseAsync({data:t.data,path:t.path,parent:i}),ctx:i}})).then(a);{let s;const i=[];for(const u of r){const c={...t,common:{...t.common,issues:[]},parent:null},l=u._parseSync({data:t.data,path:t.path,parent:c});if(l.status==="valid")return l;l.status==="dirty"&&!s&&(s={result:l,ctx:c}),c.common.issues.length&&i.push(c.common.issues)}if(s)return t.common.issues.push(...s.ctx.common.issues),s.result;const o=i.map(u=>new re(u));return b(t,{code:m.invalid_union,unionErrors:o}),x}}get options(){return this._def.options}}nt.create=(n,e)=>new nt({options:n,typeName:p.ZodUnion,...k(e)});const Rt=n=>n instanceof it?Rt(n.schema):n instanceof se?Rt(n.innerType()):n instanceof ot?[n.value]:n instanceof ke?n.options:n instanceof ut?Object.keys(n.enum):n instanceof ct?Rt(n._def.innerType):n instanceof tt?[void 0]:n instanceof rt?[null]:null;class Nt extends O{_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==g.object)return b(t,{code:m.invalid_type,expected:g.object,received:t.parsedType}),x;const r=this.discriminator,a=t.data[r],s=this.optionsMap.get(a);return s?t.common.async?s._parseAsync({data:t.data,path:t.path,parent:t}):s._parseSync({data:t.data,path:t.path,parent:t}):(b(t,{code:m.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[r]}),x)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,r){const a=new Map;for(const s of t){const i=Rt(s.shape[e]);if(!i)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(const o of i){if(a.has(o))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(o)}`);a.set(o,s)}}return new Nt({typeName:p.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:a,...k(r)})}}function mr(n,e){const t=ve(n),r=ve(e);if(n===e)return{valid:!0,data:n};if(t===g.object&&r===g.object){const a=P.objectKeys(e),s=P.objectKeys(n).filter(o=>a.indexOf(o)!==-1),i={...n,...e};for(const o of s){const u=mr(n[o],e[o]);if(!u.valid)return{valid:!1};i[o]=u.data}return{valid:!0,data:i}}else if(t===g.array&&r===g.array){if(n.length!==e.length)return{valid:!1};const a=[];for(let s=0;s<n.length;s++){const i=n[s],o=e[s],u=mr(i,o);if(!u.valid)return{valid:!1};a.push(u.data)}return{valid:!0,data:a}}else return t===g.date&&r===g.date&&+n==+e?{valid:!0,data:n}:{valid:!1}}class at extends O{_parse(e){const{status:t,ctx:r}=this._processInputParams(e),a=(s,i)=>{if(hr(s)||hr(i))return x;const o=mr(s.value,i.value);return o.valid?((fr(s)||fr(i))&&t.dirty(),{status:t.value,value:o.data}):(b(r,{code:m.invalid_intersection_types}),x)};return r.common.async?Promise.all([this._def.left._parseAsync({data:r.data,path:r.path,parent:r}),this._def.right._parseAsync({data:r.data,path:r.path,parent:r})]).then(([s,i])=>a(s,i)):a(this._def.left._parseSync({data:r.data,path:r.path,parent:r}),this._def.right._parseSync({data:r.data,path:r.path,parent:r}))}}at.create=(n,e,t)=>new at({left:n,right:e,typeName:p.ZodIntersection,...k(t)});class ce extends O{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==g.array)return b(r,{code:m.invalid_type,expected:g.array,received:r.parsedType}),x;if(r.data.length<this._def.items.length)return b(r,{code:m.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),x;!this._def.rest&&r.data.length>this._def.items.length&&(b(r,{code:m.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const s=[...r.data].map((i,o)=>{const u=this._def.items[o]||this._def.rest;return u?u._parse(new ue(r,i,r.path,o)):null}).filter(i=>!!i);return r.common.async?Promise.all(s).then(i=>U.mergeArray(t,i)):U.mergeArray(t,s)}get items(){return this._def.items}rest(e){return new ce({...this._def,rest:e})}}ce.create=(n,e)=>{if(!Array.isArray(n))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new ce({items:n,typeName:p.ZodTuple,rest:null,...k(e)})};class st extends O{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==g.object)return b(r,{code:m.invalid_type,expected:g.object,received:r.parsedType}),x;const a=[],s=this._def.keyType,i=this._def.valueType;for(const o in r.data)a.push({key:s._parse(new ue(r,o,r.path,o)),value:i._parse(new ue(r,r.data[o],r.path,o))});return r.common.async?U.mergeObjectAsync(t,a):U.mergeObjectSync(t,a)}get element(){return this._def.valueType}static create(e,t,r){return t instanceof O?new st({keyType:e,valueType:t,typeName:p.ZodRecord,...k(r)}):new st({keyType:ne.create(),valueType:e,typeName:p.ZodRecord,...k(t)})}}class jt extends O{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==g.map)return b(r,{code:m.invalid_type,expected:g.map,received:r.parsedType}),x;const a=this._def.keyType,s=this._def.valueType,i=[...r.data.entries()].map(([o,u],c)=>({key:a._parse(new ue(r,o,r.path,[c,"key"])),value:s._parse(new ue(r,u,r.path,[c,"value"]))}));if(r.common.async){const o=new Map;return Promise.resolve().then(async()=>{for(const u of i){const c=await u.key,l=await u.value;if(c.status==="aborted"||l.status==="aborted")return x;(c.status==="dirty"||l.status==="dirty")&&t.dirty(),o.set(c.value,l.value)}return{status:t.value,value:o}})}else{const o=new Map;for(const u of i){const c=u.key,l=u.value;if(c.status==="aborted"||l.status==="aborted")return x;(c.status==="dirty"||l.status==="dirty")&&t.dirty(),o.set(c.value,l.value)}return{status:t.value,value:o}}}}jt.create=(n,e,t)=>new jt({valueType:e,keyType:n,typeName:p.ZodMap,...k(t)});class Ce extends O{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==g.set)return b(r,{code:m.invalid_type,expected:g.set,received:r.parsedType}),x;const a=this._def;a.minSize!==null&&r.data.size<a.minSize.value&&(b(r,{code:m.too_small,minimum:a.minSize.value,type:"set",inclusive:!0,exact:!1,message:a.minSize.message}),t.dirty()),a.maxSize!==null&&r.data.size>a.maxSize.value&&(b(r,{code:m.too_big,maximum:a.maxSize.value,type:"set",inclusive:!0,exact:!1,message:a.maxSize.message}),t.dirty());const s=this._def.valueType;function i(u){const c=new Set;for(const l of u){if(l.status==="aborted")return x;l.status==="dirty"&&t.dirty(),c.add(l.value)}return{status:t.value,value:c}}const o=[...r.data.values()].map((u,c)=>s._parse(new ue(r,u,r.path,c)));return r.common.async?Promise.all(o).then(u=>i(u)):i(o)}min(e,t){return new Ce({...this._def,minSize:{value:e,message:v.toString(t)}})}max(e,t){return new Ce({...this._def,maxSize:{value:e,message:v.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}Ce.create=(n,e)=>new Ce({valueType:n,minSize:null,maxSize:null,typeName:p.ZodSet,...k(e)});class Ue extends O{constructor(){super(...arguments),this.validate=this.implement}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==g.function)return b(t,{code:m.invalid_type,expected:g.function,received:t.parsedType}),x;function r(o,u){return St({data:o,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,Pt(),Ye].filter(c=>!!c),issueData:{code:m.invalid_arguments,argumentsError:u}})}function a(o,u){return St({data:o,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,Pt(),Ye].filter(c=>!!c),issueData:{code:m.invalid_return_type,returnTypeError:u}})}const s={errorMap:t.common.contextualErrorMap},i=t.data;if(this._def.returns instanceof Ze){const o=this;return F(async function(...u){const c=new re([]),l=await o._def.args.parseAsync(u,s).catch(f=>{throw c.addIssue(r(u,f)),c}),d=await Reflect.apply(i,this,l);return await o._def.returns._def.type.parseAsync(d,s).catch(f=>{throw c.addIssue(a(d,f)),c})})}else{const o=this;return F(function(...u){const c=o._def.args.safeParse(u,s);if(!c.success)throw new re([r(u,c.error)]);const l=Reflect.apply(i,this,c.data),d=o._def.returns.safeParse(l,s);if(!d.success)throw new re([a(l,d.error)]);return d.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new Ue({...this._def,args:ce.create(e).rest(Ae.create())})}returns(e){return new Ue({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,t,r){return new Ue({args:e||ce.create([]).rest(Ae.create()),returns:t||Ae.create(),typeName:p.ZodFunction,...k(r)})}}class it extends O{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}it.create=(n,e)=>new it({getter:n,typeName:p.ZodLazy,...k(e)});class ot extends O{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return b(t,{received:t.data,code:m.invalid_literal,expected:this._def.value}),x}return{status:"valid",value:e.data}}get value(){return this._def.value}}ot.create=(n,e)=>new ot({value:n,typeName:p.ZodLiteral,...k(e)});function un(n,e){return new ke({values:n,typeName:p.ZodEnum,...k(e)})}class ke extends O{_parse(e){if(typeof e.data!="string"){const t=this._getOrReturnCtx(e),r=this._def.values;return b(t,{expected:P.joinValues(r),received:t.parsedType,code:m.invalid_type}),x}if(this._def.values.indexOf(e.data)===-1){const t=this._getOrReturnCtx(e),r=this._def.values;return b(t,{received:t.data,code:m.invalid_enum_value,options:r}),x}return F(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e){return ke.create(e)}exclude(e){return ke.create(this.options.filter(t=>!e.includes(t)))}}ke.create=un;class ut extends O{_parse(e){const t=P.getValidEnumValues(this._def.values),r=this._getOrReturnCtx(e);if(r.parsedType!==g.string&&r.parsedType!==g.number){const a=P.objectValues(t);return b(r,{expected:P.joinValues(a),received:r.parsedType,code:m.invalid_type}),x}if(t.indexOf(e.data)===-1){const a=P.objectValues(t);return b(r,{received:r.data,code:m.invalid_enum_value,options:a}),x}return F(e.data)}get enum(){return this._def.values}}ut.create=(n,e)=>new ut({values:n,typeName:p.ZodNativeEnum,...k(e)});class Ze extends O{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==g.promise&&t.common.async===!1)return b(t,{code:m.invalid_type,expected:g.promise,received:t.parsedType}),x;const r=t.parsedType===g.promise?t.data:Promise.resolve(t.data);return F(r.then(a=>this._def.type.parseAsync(a,{path:t.path,errorMap:t.common.contextualErrorMap})))}}Ze.create=(n,e)=>new Ze({type:n,typeName:p.ZodPromise,...k(e)});class se extends O{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===p.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:r}=this._processInputParams(e),a=this._def.effect||null,s={addIssue:i=>{b(r,i),i.fatal?t.abort():t.dirty()},get path(){return r.path}};if(s.addIssue=s.addIssue.bind(s),a.type==="preprocess"){const i=a.transform(r.data,s);return r.common.issues.length?{status:"dirty",value:r.data}:r.common.async?Promise.resolve(i).then(o=>this._def.schema._parseAsync({data:o,path:r.path,parent:r})):this._def.schema._parseSync({data:i,path:r.path,parent:r})}if(a.type==="refinement"){const i=o=>{const u=a.refinement(o,s);if(r.common.async)return Promise.resolve(u);if(u instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};if(r.common.async===!1){const o=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});return o.status==="aborted"?x:(o.status==="dirty"&&t.dirty(),i(o.value),{status:t.value,value:o.value})}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(o=>o.status==="aborted"?x:(o.status==="dirty"&&t.dirty(),i(o.value).then(()=>({status:t.value,value:o.value}))))}if(a.type==="transform")if(r.common.async===!1){const i=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});if(!Xe(i))return i;const o=a.transform(i.value,s);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:o}}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(i=>Xe(i)?Promise.resolve(a.transform(i.value,s)).then(o=>({status:t.value,value:o})):i);P.assertNever(a)}}se.create=(n,e,t)=>new se({schema:n,typeName:p.ZodEffects,effect:e,...k(t)}),se.createWithPreprocess=(n,e,t)=>new se({schema:e,effect:{type:"preprocess",transform:n},typeName:p.ZodEffects,...k(t)});class me extends O{_parse(e){return this._getType(e)===g.undefined?F(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}me.create=(n,e)=>new me({innerType:n,typeName:p.ZodOptional,...k(e)});class Ie extends O{_parse(e){return this._getType(e)===g.null?F(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Ie.create=(n,e)=>new Ie({innerType:n,typeName:p.ZodNullable,...k(e)});class ct extends O{_parse(e){const{ctx:t}=this._processInputParams(e);let r=t.data;return t.parsedType===g.undefined&&(r=this._def.defaultValue()),this._def.innerType._parse({data:r,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}ct.create=(n,e)=>new ct({innerType:n,typeName:p.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...k(e)});class $t extends O{_parse(e){const{ctx:t}=this._processInputParams(e),r={...t,common:{...t.common,issues:[]}},a=this._def.innerType._parse({data:r.data,path:r.path,parent:{...r}});return At(a)?a.then(s=>({status:"valid",value:s.status==="valid"?s.value:this._def.catchValue({get error(){return new re(r.common.issues)},input:r.data})})):{status:"valid",value:a.status==="valid"?a.value:this._def.catchValue({get error(){return new re(r.common.issues)},input:r.data})}}removeCatch(){return this._def.innerType}}$t.create=(n,e)=>new $t({innerType:n,typeName:p.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...k(e)});class Lt extends O{_parse(e){if(this._getType(e)!==g.nan){const r=this._getOrReturnCtx(e);return b(r,{code:m.invalid_type,expected:g.nan,received:r.parsedType}),x}return{status:"valid",value:e.data}}}Lt.create=n=>new Lt({typeName:p.ZodNaN,...k(n)});const Ns=Symbol("zod_brand");class cn extends O{_parse(e){const{ctx:t}=this._processInputParams(e),r=t.data;return this._def.type._parse({data:r,path:t.path,parent:t})}unwrap(){return this._def.type}}class lt extends O{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.common.async)return(async()=>{const s=await this._def.in._parseAsync({data:r.data,path:r.path,parent:r});return s.status==="aborted"?x:s.status==="dirty"?(t.dirty(),sn(s.value)):this._def.out._parseAsync({data:s.value,path:r.path,parent:r})})();{const a=this._def.in._parseSync({data:r.data,path:r.path,parent:r});return a.status==="aborted"?x:a.status==="dirty"?(t.dirty(),{status:"dirty",value:a.value}):this._def.out._parseSync({data:a.value,path:r.path,parent:r})}}static create(e,t){return new lt({in:e,out:t,typeName:p.ZodPipeline})}}class Dt extends O{_parse(e){const t=this._def.innerType._parse(e);return Xe(t)&&(t.value=Object.freeze(t.value)),t}}Dt.create=(n,e)=>new Dt({innerType:n,typeName:p.ZodReadonly,...k(e)});const ln=(n,e={},t)=>n?De.create().superRefine((r,a)=>{var s,i;if(!n(r)){const o=typeof e=="function"?e(r):typeof e=="string"?{message:e}:e,u=(i=(s=o.fatal)!==null&&s!==void 0?s:t)!==null&&i!==void 0?i:!0,c=typeof o=="string"?{message:o}:o;a.addIssue({code:"custom",...c,fatal:u})}}):De.create(),js={object:j.lazycreate};var p;(function(n){n.ZodString="ZodString",n.ZodNumber="ZodNumber",n.ZodNaN="ZodNaN",n.ZodBigInt="ZodBigInt",n.ZodBoolean="ZodBoolean",n.ZodDate="ZodDate",n.ZodSymbol="ZodSymbol",n.ZodUndefined="ZodUndefined",n.ZodNull="ZodNull",n.ZodAny="ZodAny",n.ZodUnknown="ZodUnknown",n.ZodNever="ZodNever",n.ZodVoid="ZodVoid",n.ZodArray="ZodArray",n.ZodObject="ZodObject",n.ZodUnion="ZodUnion",n.ZodDiscriminatedUnion="ZodDiscriminatedUnion",n.ZodIntersection="ZodIntersection",n.ZodTuple="ZodTuple",n.ZodRecord="ZodRecord",n.ZodMap="ZodMap",n.ZodSet="ZodSet",n.ZodFunction="ZodFunction",n.ZodLazy="ZodLazy",n.ZodLiteral="ZodLiteral",n.ZodEnum="ZodEnum",n.ZodEffects="ZodEffects",n.ZodNativeEnum="ZodNativeEnum",n.ZodOptional="ZodOptional",n.ZodNullable="ZodNullable",n.ZodDefault="ZodDefault",n.ZodCatch="ZodCatch",n.ZodPromise="ZodPromise",n.ZodBranded="ZodBranded",n.ZodPipeline="ZodPipeline",n.ZodReadonly="ZodReadonly"})(p||(p={}));const $s=(n,e={message:`Input not instance of ${n.name}`})=>ln(t=>t instanceof n,e),dn=ne.create,hn=we.create,Ls=Lt.create,Ds=xe.create,fn=et.create,Ms=Se.create,Us=Ct.create,Zs=tt.create,Bs=rt.create,Fs=De.create,zs=Ae.create,Hs=pe.create,Vs=It.create,Gs=ae.create,qs=j.create,Js=j.strictCreate,Ws=nt.create,Ks=Nt.create,Qs=at.create,Ys=ce.create,Xs=st.create,ei=jt.create,ti=Ce.create,ri=Ue.create,ni=it.create,ai=ot.create,si=ke.create,ii=ut.create,oi=Ze.create,pn=se.create,ui=me.create,ci=Ie.create,li=se.createWithPreprocess,di=lt.create;var mn=Object.freeze({__proto__:null,defaultErrorMap:Ye,setErrorMap:vs,getErrorMap:Pt,makeIssue:St,EMPTY_PATH:ws,addIssueToContext:b,ParseStatus:U,INVALID:x,DIRTY:sn,OK:F,isAborted:hr,isDirty:fr,isValid:Xe,isAsync:At,get util(){return P},get objectUtil(){return dr},ZodParsedType:g,getParsedType:ve,ZodType:O,ZodString:ne,ZodNumber:we,ZodBigInt:xe,ZodBoolean:et,ZodDate:Se,ZodSymbol:Ct,ZodUndefined:tt,ZodNull:rt,ZodAny:De,ZodUnknown:Ae,ZodNever:pe,ZodVoid:It,ZodArray:ae,ZodObject:j,ZodUnion:nt,ZodDiscriminatedUnion:Nt,ZodIntersection:at,ZodTuple:ce,ZodRecord:st,ZodMap:jt,ZodSet:Ce,ZodFunction:Ue,ZodLazy:it,ZodLiteral:ot,ZodEnum:ke,ZodNativeEnum:ut,ZodPromise:Ze,ZodEffects:se,ZodTransformer:se,ZodOptional:me,ZodNullable:Ie,ZodDefault:ct,ZodCatch:$t,ZodNaN:Lt,BRAND:Ns,ZodBranded:cn,ZodPipeline:lt,ZodReadonly:Dt,custom:ln,Schema:O,ZodSchema:O,late:js,get ZodFirstPartyTypeKind(){return p},coerce:{string:n=>ne.create({...n,coerce:!0}),number:n=>we.create({...n,coerce:!0}),boolean:n=>et.create({...n,coerce:!0}),bigint:n=>xe.create({...n,coerce:!0}),date:n=>Se.create({...n,coerce:!0})},any:Fs,array:Gs,bigint:Ds,boolean:fn,date:Ms,discriminatedUnion:Ks,effect:pn,enum:si,function:ri,instanceof:$s,intersection:Qs,lazy:ni,literal:ai,map:ei,nan:Ls,nativeEnum:ii,never:Hs,null:Bs,nullable:ci,number:hn,object:qs,oboolean:()=>fn().optional(),onumber:()=>hn().optional(),optional:ui,ostring:()=>dn().optional(),pipeline:di,preprocess:li,promise:oi,record:Xs,set:ti,strictObject:Js,string:dn,symbol:Us,transformer:pn,tuple:Ys,undefined:Zs,union:Ws,unknown:zs,void:Vs,NEVER:x,ZodIssueCode:m,quotelessJson:_s,ZodError:re});/*!
 * https://github.com/Starcounter-Jack/JSON-Patch
 * (c) 2017-2022 Joachim Wester
 * MIT licensed
 */const hi=Object.prototype.hasOwnProperty;function fi(n,e){return hi.call(n,e)}function pi(n){if(Array.isArray(n)){const t=new Array(n.length);for(let r=0;r<t.length;r++)t[r]=""+r;return t}if(Object.keys)return Object.keys(n);let e=[];for(let t in n)fi(n,t)&&e.push(t);return e}function Be(n){switch(typeof n){case"object":return JSON.parse(JSON.stringify(n));case"undefined":return null;default:return n}}function yr(n){let e=0;const t=n.length;let r;for(;e<t;){if(r=n.charCodeAt(e),r>=48&&r<=57){e++;continue}return!1}return!0}function mi(n){return n.replace(/~1/g,"/").replace(/~0/g,"~")}function gr(n){if(n===void 0)return!0;if(n){if(Array.isArray(n)){for(let t=0,r=n.length;t<r;t++)if(gr(n[t]))return!0}else if(typeof n=="object"){const t=pi(n),r=t.length;for(var e=0;e<r;e++)if(gr(n[t[e]]))return!0}}return!1}function yn(n,e){const t=[n];for(const r in e){const a=typeof e[r]=="object"?JSON.stringify(e[r],null,2):e[r];typeof a<"u"&&t.push(`${r}: ${a}`)}return t.join(`
`)}class yi extends Error{constructor(e,t,r,a,s){super(yn(e,{name:t,index:r,operation:a,tree:s})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.setPrototypeOf(this,new.target.prototype),this.message=yn(e,{name:t,index:r,operation:a,tree:s})}}const $=yi,Fe={add:function(n,e,t){return n[e]=this.value,{newDocument:t}},remove:function(n,e,t){var r=n[e];return delete n[e],{newDocument:t,removed:r}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:function(n,e,t){let r=br(t,this.path);r&&(r=Be(r));const a=dt(t,{op:"remove",path:this.from}).removed;return dt(t,{op:"add",path:this.path,value:a}),{newDocument:t,removed:r}},copy:function(n,e,t){const r=br(t,this.from);return dt(t,{op:"add",path:this.path,value:Be(r)}),{newDocument:t}},test:function(n,e,t){return{newDocument:t,test:Ut(n[e],this.value)}},_get:function(n,e,t){return this.value=n[e],{newDocument:t}}};var gi={add:function(n,e,t){return yr(e)?n.splice(e,0,this.value):n[e]=this.value,{newDocument:t,index:e}},remove:function(n,e,t){var r=n.splice(e,1);return{newDocument:t,removed:r[0]}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:Fe.move,copy:Fe.copy,test:Fe.test,_get:Fe._get};function br(n,e){if(e=="")return n;var t={op:"_get",path:e};return dt(n,t),t.value}function dt(n,e,t=!1,r=!0,a=!0,s=0){if(t&&(typeof t=="function"?t(e,0,n,e.path):_r(e,0)),e.path===""){let i={newDocument:n};if(e.op==="add")return i.newDocument=e.value,i;if(e.op==="replace")return i.newDocument=e.value,i.removed=n,i;if(e.op==="move"||e.op==="copy")return i.newDocument=br(n,e.from),e.op==="move"&&(i.removed=n),i;if(e.op==="test"){if(i.test=Ut(n,e.value),i.test===!1)throw new $("Test operation failed","TEST_OPERATION_FAILED",s,e,n);return i.newDocument=n,i}else{if(e.op==="remove")return i.removed=n,i.newDocument=null,i;if(e.op==="_get")return e.value=n,i;if(t)throw new $("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",s,e,n);return i}}else{r||(n=Be(n));const o=(e.path||"").split("/");let u=n,c=1,l=o.length,d,h,f;for(typeof t=="function"?f=t:f=_r;;){if(h=o[c],h&&h.indexOf("~")!=-1&&(h=mi(h)),a&&(h=="__proto__"||h=="prototype"&&c>0&&o[c-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(t&&d===void 0&&(u[h]===void 0?d=o.slice(0,c).join("/"):c==l-1&&(d=e.path),d!==void 0&&f(e,0,n,d)),c++,Array.isArray(u)){if(h==="-")h=u.length;else{if(t&&!yr(h))throw new $("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",s,e,n);yr(h)&&(h=~~h)}if(c>=l){if(t&&e.op==="add"&&h>u.length)throw new $("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",s,e,n);const y=gi[e.op].call(e,u,h,n);if(y.test===!1)throw new $("Test operation failed","TEST_OPERATION_FAILED",s,e,n);return y}}else if(c>=l){const y=Fe[e.op].call(e,u,h,n);if(y.test===!1)throw new $("Test operation failed","TEST_OPERATION_FAILED",s,e,n);return y}if(u=u[h],t&&c<l&&(!u||typeof u!="object"))throw new $("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",s,e,n)}}}function Mt(n,e,t,r=!0,a=!0){if(t&&!Array.isArray(e))throw new $("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(n=Be(n));const s=new Array(e.length);for(let i=0,o=e.length;i<o;i++)s[i]=dt(n,e[i],t,!0,a,i),n=s[i].newDocument;return s.newDocument=n,s}function _r(n,e,t,r){if(typeof n!="object"||n===null||Array.isArray(n))throw new $("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,n,t);if(Fe[n.op]){if(typeof n.path!="string")throw new $("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,n,t);if(n.path.indexOf("/")!==0&&n.path.length>0)throw new $('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,n,t);if((n.op==="move"||n.op==="copy")&&typeof n.from!="string")throw new $("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&n.value===void 0)throw new $("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&gr(n.value))throw new $("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,n,t);if(t){if(n.op=="add"){var a=n.path.split("/").length,s=r.split("/").length;if(a!==s+1&&a!==s)throw new $("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,n,t)}else if(n.op==="replace"||n.op==="remove"||n.op==="_get"){if(n.path!==r)throw new $("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,n,t)}else if(n.op==="move"||n.op==="copy"){var i={op:"_get",path:n.from,value:void 0},o=bi([i],t);if(o&&o.name==="OPERATION_PATH_UNRESOLVABLE")throw new $("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,n,t)}}}else throw new $("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,n,t)}function bi(n,e,t){try{if(!Array.isArray(n))throw new $("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)Mt(Be(e),Be(n),t||!0);else{t=t||_r;for(var r=0;r<n.length;r++)t(n[r],r,e,void 0)}}catch(a){if(a instanceof $)return a;throw a}}function Ut(n,e){if(n===e)return!0;if(n&&e&&typeof n=="object"&&typeof e=="object"){var t=Array.isArray(n),r=Array.isArray(e),a,s,i;if(t&&r){if(s=n.length,s!=e.length)return!1;for(a=s;a--!==0;)if(!Ut(n[a],e[a]))return!1;return!0}if(t!=r)return!1;var o=Object.keys(n);if(s=o.length,s!==Object.keys(e).length)return!1;for(a=s;a--!==0;)if(!e.hasOwnProperty(o[a]))return!1;for(a=s;a--!==0;)if(i=o[a],!Ut(n[i],e[i]))return!1;return!0}return n!==n&&e!==e}class le extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){const t=this.reader.cancel();this.reader.releaseLock(),await t}throw e}[Symbol.asyncIterator](){return this}static fromReadableStream(e){const t=e.getReader();return new le({start(r){return a();function a(){return t.read().then(({done:s,value:i})=>{if(s){r.close();return}return r.enqueue(i),a()})}},cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new le({async pull(t){const{value:r,done:a}=await e.next();a&&t.close(),t.enqueue(r)},async cancel(t){await e.return(t)}})}}function gn(n,e=2){const t=Array.from({length:e},()=>[]);return t.map(async function*(a){for(;;)if(a.length===0){const s=await n.next();for(const i of t)i.push(s)}else{if(a[0].done)return;yield a.shift().value}})}function ze(n,e){if(Array.isArray(n)&&Array.isArray(e))return n.concat(e);if(typeof n=="string"&&typeof e=="string")return n+e;if(typeof n=="number"&&typeof e=="number")return n+e;if("concat"in n&&typeof n.concat=="function")return n.concat(e);if(typeof n=="object"&&typeof e=="object"){const t={...n};for(const[r,a]of Object.entries(e))r in t&&!Array.isArray(t[r])?t[r]=ze(t[r],a):t[r]=a;return t}else throw new Error(`Cannot concat ${typeof n} and ${typeof e}`)}class He{constructor(e,t){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e,this.setup=new Promise((r,a)=>{this.firstResult=e.next(),t?this.firstResult.then(t).then(r,a):this.firstResult.then(s=>r(void 0),a)})}async next(...e){return this.firstResultUsed?this.generator.next(...e):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}}async function _i(n,e,t,...r){const a=new He(e,t),s=await a.setup;return{output:n(a,s,...r),setup:s}}class Te{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){const t=this.ops.concat(e.ops),r=Mt({},t);return new ht({ops:t,state:r[r.length-1].newDocument})}}class ht extends Te{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){const t=this.ops.concat(e.ops),r=Mt(this.state,e.ops);return new ht({ops:t,state:r[r.length-1].newDocument})}static fromRunLogPatch(e){const t=Mt({},e.ops);return new ht({ops:e.ops,state:t[t.length-1].newDocument})}}async function bn(n,e){if(e==="original")throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:t}=n;if(["retriever","llm","prompt"].includes(n.run_type))return t;if(!(Object.keys(t).length===1&&(t==null?void 0:t.input)===""))return t.input}async function _n(n,e){const{outputs:t}=n;return e==="original"||["retriever","llm","prompt"].includes(n.run_type)?t:t!==void 0&&Object.keys(t).length===1&&(t==null?void 0:t.output)!==void 0?t.output:t}function vi(n){return n!==void 0&&n.message!==void 0}class vn extends bt{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),this.autoClose=(e==null?void 0:e.autoClose)??!0,this.includeNames=e==null?void 0:e.includeNames,this.includeTypes=e==null?void 0:e.includeTypes,this.includeTags=e==null?void 0:e.includeTags,this.excludeNames=e==null?void 0:e.excludeNames,this.excludeTypes=e==null?void 0:e.excludeTypes,this.excludeTags=e==null?void 0:e.excludeTags,this._schemaFormat=(e==null?void 0:e._schemaFormat)??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=le.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const t=e.tags??[];let r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(r=r||t.find(a=>{var s;return(s=this.includeTags)==null?void 0:s.includes(a)})!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(r=r&&t.every(a=>{var s;return!((s=this.excludeTags)!=null&&s.includes(a))})),r}async*tapOutputIterable(e,t){for await(const r of t){if(e!==this.rootId){const a=this.keyMapByRunId[e];a&&await this.writer.write(new Te({ops:[{op:"add",path:`/logs/${a}/streamed_output/-`,value:r}]}))}yield r}}async onRunCreate(e){var a;if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new Te({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=t===1?e.name:`${e.name}:${t}`;const r={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:((a=e.extra)==null?void 0:a.metadata)??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};this._schemaFormat==="streaming_events"&&(r.inputs=await bn(e,this._schemaFormat)),await this.writer.write(new Te({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{const t=this.keyMapByRunId[e.id];if(t===void 0)return;const r=[];this._schemaFormat==="streaming_events"&&r.push({op:"replace",path:`/logs/${t}/inputs`,value:await bn(e,this._schemaFormat)}),r.push({op:"add",path:`/logs/${t}/final_output`,value:await _n(e,this._schemaFormat)}),e.end_time!==void 0&&r.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});const a=new Te({ops:r});await this.writer.write(a)}finally{if(e.id===this.rootId){const t=new Te({ops:[{op:"replace",path:"/final_output",value:await _n(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,r){const a=this.keyMapByRunId[e.id];if(a===void 0)return;const s=e.inputs.messages!==void 0;let i;s?vi(r==null?void 0:r.chunk)?i=r==null?void 0:r.chunk:i=new yt(t):i=t;const o=new Te({ops:[{op:"add",path:`/logs/${a}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${a}/streamed_output/-`,value:i}]});await this.writer.write(o)}}class wi{getStore(){}run(e,t){t()}}class xi{constructor(){Object.defineProperty(this,"asyncLocalStorage",{enumerable:!0,configurable:!0,writable:!0,value:new wi}),Object.defineProperty(this,"hasBeenInitialized",{enumerable:!0,configurable:!0,writable:!0,value:!1})}getInstance(){return this.asyncLocalStorage}initializeGlobalInstance(e){this.hasBeenInitialized||(this.hasBeenInitialized=!0,this.asyncLocalStorage=e)}}const vr=new xi,wr=25;async function Re(n){return H.configure(n==null?void 0:n.callbacks,void 0,n==null?void 0:n.tags,void 0,n==null?void 0:n.metadata)}function wn(...n){const e=J();for(const t of n.filter(r=>!!r))for(const r of Object.keys(t))if(r==="metadata")e[r]={...e[r],...t[r]};else if(r==="tags")e[r]=[...new Set(e[r].concat(t[r]??[]))];else if(r==="configurable")e[r]={...e[r],...t[r]};else if(r==="callbacks"){const a=e.callbacks,s=t.callbacks;if(Array.isArray(s))if(!a)e.callbacks=s;else if(Array.isArray(a))e.callbacks=a.concat(s);else{const i=a.copy();for(const o of s)i.addHandler(Tt(o),!0);e.callbacks=i}else if(s)if(!a)e.callbacks=s;else if(Array.isArray(a)){const i=s.copy();for(const o of a)i.addHandler(Tt(o),!0);e.callbacks=i}else e.callbacks=new H(s._parentRunId,{handlers:a.handlers.concat(s.handlers),inheritableHandlers:a.inheritableHandlers.concat(s.inheritableHandlers),tags:Array.from(new Set(a.tags.concat(s.tags))),inheritableTags:Array.from(new Set(a.inheritableTags.concat(s.inheritableTags))),metadata:{...a.metadata,...s.metadata}})}else{const a=r;e[a]=t[a]??e[a]}return e}const ki=new Set(["string","number","boolean"]);function J(n){var r;const e=n??vr.getInstance().getStore();let t={tags:[],metadata:{},callbacks:void 0,recursionLimit:25};if(e&&(t={...t,...e}),e!=null&&e.configurable)for(const a of Object.keys(e.configurable))ki.has(typeof e.configurable[a])&&!((r=t.metadata)!=null&&r[a])&&(t.metadata||(t.metadata={}),t.metadata[a]=e.configurable[a]);return t}function V(n={},{callbacks:e,maxConcurrency:t,recursionLimit:r,runName:a,configurable:s}={}){const i=J(n);return e!==void 0&&(delete i.runName,i.callbacks=e),r!==void 0&&(i.recursionLimit=r),t!==void 0&&(i.maxConcurrency=t),a!==void 0&&(i.runName=a),s!==void 0&&(i.configurable={...i.configurable,...s}),i}class xn extends bt{constructor({config:e,onStart:t,onEnd:r,onError:a}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=r,this.argOnError=a}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&(this.argOnStart.length===1?await this.argOnStart(e):this.argOnStart.length===2&&await this.argOnStart(e,this.config)))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&(this.argOnError.length===1?await this.argOnError(e):this.argOnError.length===2&&await this.argOnError(e,this.config)):this.argOnEnd&&(this.argOnEnd.length===1?await this.argOnEnd(e):this.argOnEnd.length===2&&await this.argOnEnd(e,this.config)))}}function kn(n){return n?n.lc_runnable:!1}class Ti{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let r=this.includeNames===void 0&&this.includeTypes===void 0&&this.includeTags===void 0;const a=e.tags??[];return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(t)),this.includeTags!==void 0&&(r=r||a.some(s=>{var i;return(i=this.includeTags)==null?void 0:i.includes(s)})),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(t)),this.excludeTags!==void 0&&(r=r&&a.every(s=>{var i;return!((i=this.excludeTags)!=null&&i.includes(s))})),r}}function Tn(n,e,t,r){r!=null&&r.errorMessages&&t&&(n.errorMessage={...n.errorMessage,[e]:t})}function C(n,e,t,r,a){n[e]=t,Tn(n,e,r,a)}const On={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"string",mapStrategy:"entries",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",emailStrategy:"format:email"},Oi=n=>typeof n=="string"?{...On,name:n}:{...On,...n};function Ei(){return{}}function Pi(n,e){var r,a;const t={type:"array"};return((a=(r=n.type)==null?void 0:r._def)==null?void 0:a.typeName)!==p.ZodAny&&(t.items=S(n.type._def,{...e,currentPath:[...e.currentPath,"items"]})),n.minLength&&C(t,"minItems",n.minLength.value,n.minLength.message,e),n.maxLength&&C(t,"maxItems",n.maxLength.value,n.maxLength.message,e),n.exactLength&&(C(t,"minItems",n.exactLength.value,n.exactLength.message,e),C(t,"maxItems",n.exactLength.value,n.exactLength.message,e)),t}function Si(n,e){const t={type:"integer",format:"int64"};if(!n.checks)return t;for(const r of n.checks)switch(r.kind){case"min":e.target==="jsonSchema7"?r.inclusive?C(t,"minimum",r.value,r.message,e):C(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),C(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?C(t,"maximum",r.value,r.message,e):C(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),C(t,"maximum",r.value,r.message,e));break;case"multipleOf":C(t,"multipleOf",r.value,r.message,e);break}return t}function Ai(){return{type:"boolean"}}function Ci(n,e){return S(n.type._def,e)}const Ii=(n,e)=>S(n.innerType._def,e);function Ri(n,e){return e.dateStrategy=="integer"?Ni(n,e):{type:"string",format:"date-time"}}const Ni=(n,e)=>{const t={type:"integer",format:"unix-time"};for(const r of n.checks)switch(r.kind){case"min":e.target==="jsonSchema7"&&C(t,"minimum",r.value,r.message,e);break;case"max":e.target==="jsonSchema7"&&C(t,"maximum",r.value,r.message,e);break}return t};function ji(n,e){return{...S(n.innerType._def,e),default:n.defaultValue()}}function $i(n,e){return e.effectStrategy==="input"?S(n.schema._def,e):{}}function Li(n){return{type:"string",enum:n.values}}const Di=n=>"type"in n&&n.type==="string"?!1:"allOf"in n;function Mi(n,e){const t=[S(n.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),S(n.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(s=>!!s);let r=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const a=[];return t.forEach(s=>{if(Di(s))a.push(...s.allOf),s.unevaluatedProperties===void 0&&(r=void 0);else{let i=s;if("additionalProperties"in s&&s.additionalProperties===!1){const{additionalProperties:o,...u}=s;i=u}else r=void 0;a.push(i)}}),a.length?{allOf:a,...r}:void 0}function Ui(n,e){const t=typeof n.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(n.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[n.value]}:{type:t==="bigint"?"integer":t,const:n.value}}const ft={cuid:"^[cC][^\\s-]{8,}$",cuid2:"^[a-z][a-z0-9]*$",ulid:"^[0-9A-HJKMNP-TV-Z]{26}$",email:"^(?!\\.)(?!.*\\.\\.)([a-zA-Z0-9_+-\\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\\-]*\\.)+[a-zA-Z]{2,}$",emoji:"^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$",uuid:"^[0-9a-fA-F]{8}\\b-[0-9a-fA-F]{4}\\b-[0-9a-fA-F]{4}\\b-[0-9a-fA-F]{4}\\b-[0-9a-fA-F]{12}$",ipv4:"^(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))$",ipv6:"^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$"};function En(n,e){const t={type:"string"};function r(a){return e.patternStrategy==="escape"?Zi(a):a}if(n.checks)for(const a of n.checks)switch(a.kind){case"min":C(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,a.value):a.value,a.message,e);break;case"max":C(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,a.value):a.value,a.message,e);break;case"email":switch(e.emailStrategy){case"format:email":Ne(t,"email",a.message,e);break;case"format:idn-email":Ne(t,"idn-email",a.message,e);break;case"pattern:zod":ye(t,ft.email,a.message,e);break}break;case"url":Ne(t,"uri",a.message,e);break;case"uuid":Ne(t,"uuid",a.message,e);break;case"regex":ye(t,a.regex.source,a.message,e);break;case"cuid":ye(t,ft.cuid,a.message,e);break;case"cuid2":ye(t,ft.cuid2,a.message,e);break;case"startsWith":ye(t,"^"+r(a.value),a.message,e);break;case"endsWith":ye(t,r(a.value)+"$",a.message,e);break;case"datetime":Ne(t,"date-time",a.message,e);break;case"length":C(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,a.value):a.value,a.message,e),C(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,a.value):a.value,a.message,e);break;case"includes":{ye(t,r(a.value),a.message,e);break}case"ip":{a.version!=="v6"&&Ne(t,"ipv4",a.message,e),a.version!=="v4"&&Ne(t,"ipv6",a.message,e);break}case"emoji":ye(t,ft.emoji,a.message,e);break;case"ulid":{ye(t,ft.ulid,a.message,e);break}}return t}const Zi=n=>Array.from(n).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),Ne=(n,e,t,r)=>{var a;n.format||(a=n.anyOf)!=null&&a.some(s=>s.format)?(n.anyOf||(n.anyOf=[]),n.format&&(n.anyOf.push({format:n.format,...n.errorMessage&&r.errorMessages&&{errorMessage:{format:n.errorMessage.format}}}),delete n.format,n.errorMessage&&(delete n.errorMessage.format,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.anyOf.push({format:e,...t&&r.errorMessages&&{errorMessage:{format:t}}})):C(n,"format",e,t,r)},ye=(n,e,t,r)=>{var a;n.pattern||(a=n.allOf)!=null&&a.some(s=>s.pattern)?(n.allOf||(n.allOf=[]),n.pattern&&(n.allOf.push({pattern:n.pattern,...n.errorMessage&&r.errorMessages&&{errorMessage:{pattern:n.errorMessage.pattern}}}),delete n.pattern,n.errorMessage&&(delete n.errorMessage.pattern,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.allOf.push({pattern:e,...t&&r.errorMessages&&{errorMessage:{pattern:t}}})):C(n,"pattern",e,t,r)};function Pn(n,e){var r,a,s,i;if(e.target==="openApi3"&&((r=n.keyType)==null?void 0:r._def.typeName)===p.ZodEnum)return{type:"object",required:n.keyType._def.values,properties:n.keyType._def.values.reduce((o,u)=>({...o,[u]:S(n.valueType._def,{...e,currentPath:[...e.currentPath,"properties",u]})??{}}),{}),additionalProperties:!1};const t={type:"object",additionalProperties:S(n.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??{}};if(e.target==="openApi3")return t;if(((a=n.keyType)==null?void 0:a._def.typeName)===p.ZodString&&((s=n.keyType._def.checks)!=null&&s.length)){const o=Object.entries(En(n.keyType._def,e)).reduce((u,[c,l])=>c==="type"?u:{...u,[c]:l},{});return{...t,propertyNames:o}}else if(((i=n.keyType)==null?void 0:i._def.typeName)===p.ZodEnum)return{...t,propertyNames:{enum:n.keyType._def.values}};return t}function Bi(n,e){if(e.mapStrategy==="record")return Pn(n,e);const t=S(n.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},r=S(n.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[t,r],minItems:2,maxItems:2}}}function Fi(n){const e=n.values,r=Object.keys(n.values).filter(s=>typeof e[e[s]]!="number").map(s=>e[s]),a=Array.from(new Set(r.map(s=>typeof s)));return{type:a.length===1?a[0]==="string"?"string":"number":["string","number"],enum:r}}function zi(){return{not:{}}}function Hi(n){return n.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const Zt={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function Vi(n,e){if(e.target==="openApi3")return Sn(n,e);const t=n.options instanceof Map?Array.from(n.options.values()):n.options;if(t.every(r=>r._def.typeName in Zt&&(!r._def.checks||!r._def.checks.length))){const r=t.reduce((a,s)=>{const i=Zt[s._def.typeName];return i&&!a.includes(i)?[...a,i]:a},[]);return{type:r.length>1?r:r[0]}}else if(t.every(r=>r._def.typeName==="ZodLiteral"&&!r.description)){const r=t.reduce((a,s)=>{const i=typeof s._def.value;switch(i){case"string":case"number":case"boolean":return[...a,i];case"bigint":return[...a,"integer"];case"object":if(s._def.value===null)return[...a,"null"];case"symbol":case"undefined":case"function":default:return a}},[]);if(r.length===t.length){const a=r.filter((s,i,o)=>o.indexOf(s)===i);return{type:a.length>1?a:a[0],enum:t.reduce((s,i)=>s.includes(i._def.value)?s:[...s,i._def.value],[])}}}else if(t.every(r=>r._def.typeName==="ZodEnum"))return{type:"string",enum:t.reduce((r,a)=>[...r,...a._def.values.filter(s=>!r.includes(s))],[])};return Sn(n,e)}const Sn=(n,e)=>{const t=(n.options instanceof Map?Array.from(n.options.values()):n.options).map((r,a)=>S(r._def,{...e,currentPath:[...e.currentPath,"anyOf",`${a}`]})).filter(r=>!!r&&(!e.strictUnions||typeof r=="object"&&Object.keys(r).length>0));return t.length?{anyOf:t}:void 0};function Gi(n,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(n.innerType._def.typeName)&&(!n.innerType._def.checks||!n.innerType._def.checks.length))return e.target==="openApi3"?{type:Zt[n.innerType._def.typeName],nullable:!0}:{type:[Zt[n.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const r=S(n.innerType._def,{...e,currentPath:[...e.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}const t=S(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return t&&{anyOf:[t,{type:"null"}]}}function qi(n,e){const t={type:"number"};if(!n.checks)return t;for(const r of n.checks)switch(r.kind){case"int":t.type="integer",Tn(t,"type",r.message,e);break;case"min":e.target==="jsonSchema7"?r.inclusive?C(t,"minimum",r.value,r.message,e):C(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),C(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?C(t,"maximum",r.value,r.message,e):C(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),C(t,"maximum",r.value,r.message,e));break;case"multipleOf":C(t,"multipleOf",r.value,r.message,e);break}return t}function Ji(n,e){const t={type:"object",...Object.entries(n.shape()).reduce((r,[a,s])=>{if(s===void 0||s._def===void 0)return r;const i=S(s._def,{...e,currentPath:[...e.currentPath,"properties",a],propertyPath:[...e.currentPath,"properties",a]});return i===void 0?r:{properties:{...r.properties,[a]:i},required:s.isOptional()?r.required:[...r.required,a]}},{properties:{},required:[]}),additionalProperties:n.catchall._def.typeName==="ZodNever"?n.unknownKeys==="passthrough":S(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0};return t.required.length||delete t.required,t}const Wi=(n,e)=>{var r;if(e.currentPath.toString()===((r=e.propertyPath)==null?void 0:r.toString()))return S(n.innerType._def,e);const t=S(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return t?{anyOf:[{not:{}},t]}:{}},Ki=(n,e)=>{if(e.pipeStrategy==="input")return S(n.in._def,e);if(e.pipeStrategy==="output")return S(n.out._def,e);const t=S(n.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),r=S(n.out._def,{...e,currentPath:[...e.currentPath,"allOf",t?"1":"0"]});return{allOf:[t,r].filter(a=>a!==void 0)}};function Qi(n,e){return S(n.type._def,e)}function Yi(n,e){const r={type:"array",uniqueItems:!0,items:S(n.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return n.minSize&&C(r,"minItems",n.minSize.value,n.minSize.message,e),n.maxSize&&C(r,"maxItems",n.maxSize.value,n.maxSize.message,e),r}function Xi(n,e){return n.rest?{type:"array",minItems:n.items.length,items:n.items.map((t,r)=>S(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[]),additionalItems:S(n.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:n.items.length,maxItems:n.items.length,items:n.items.map((t,r)=>S(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[])}}function eo(){return{not:{}}}function to(){return{}}const ro=(n,e)=>S(n.innerType._def,e);function S(n,e,t=!1){const r=e.seen.get(n);if(r&&!t){const i=no(r,e);if(i!==void 0)return i}const a={def:n,path:e.currentPath,jsonSchema:void 0};e.seen.set(n,a);const s=so(n,n.typeName,e);return s&&io(n,e,s),a.jsonSchema=s,s}const no=(n,e)=>{switch(e.$refStrategy){case"root":return{$ref:n.path.join("/")};case"relative":return{$ref:ao(e.currentPath,n.path)};case"none":case"seen":return n.path.length<e.currentPath.length&&n.path.every((t,r)=>e.currentPath[r]===t)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},ao=(n,e)=>{let t=0;for(;t<n.length&&t<e.length&&n[t]===e[t];t++);return[(n.length-t).toString(),...e.slice(t)].join("/")},so=(n,e,t)=>{switch(e){case p.ZodString:return En(n,t);case p.ZodNumber:return qi(n,t);case p.ZodObject:return Ji(n,t);case p.ZodBigInt:return Si(n,t);case p.ZodBoolean:return Ai();case p.ZodDate:return Ri(n,t);case p.ZodUndefined:return eo();case p.ZodNull:return Hi(t);case p.ZodArray:return Pi(n,t);case p.ZodUnion:case p.ZodDiscriminatedUnion:return Vi(n,t);case p.ZodIntersection:return Mi(n,t);case p.ZodTuple:return Xi(n,t);case p.ZodRecord:return Pn(n,t);case p.ZodLiteral:return Ui(n,t);case p.ZodEnum:return Li(n);case p.ZodNativeEnum:return Fi(n);case p.ZodNullable:return Gi(n,t);case p.ZodOptional:return Wi(n,t);case p.ZodMap:return Bi(n,t);case p.ZodSet:return Yi(n,t);case p.ZodLazy:return S(n.getter()._def,t);case p.ZodPromise:return Qi(n,t);case p.ZodNaN:case p.ZodNever:return zi();case p.ZodEffects:return $i(n,t);case p.ZodAny:return Ei();case p.ZodUnknown:return to();case p.ZodDefault:return ji(n,t);case p.ZodBranded:return Ci(n,t);case p.ZodReadonly:return ro(n,t);case p.ZodCatch:return Ii(n,t);case p.ZodPipeline:return Ki(n,t);case p.ZodFunction:case p.ZodVoid:case p.ZodSymbol:return;default:return(r=>{})()}},io=(n,e,t)=>(n.description&&(t.description=n.description,e.markdownDescription&&(t.markdownDescription=n.description)),t),oo=n=>{const e=Oi(n),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:t,propertyPath:void 0,seen:new Map(Object.entries(e.definitions).map(([r,a])=>[a._def,{def:a._def,path:[...e.basePath,e.definitionPath,r],jsonSchema:void 0}]))}},uo=(n,e)=>{const t=oo(e),r=typeof e=="object"&&e.definitions?Object.entries(e.definitions).reduce((o,[u,c])=>({...o,[u]:S(c._def,{...t,currentPath:[...t.basePath,t.definitionPath,u]},!0)??{}}),{}):void 0,a=typeof e=="string"?e:e==null?void 0:e.name,s=S(n._def,a===void 0?t:{...t,currentPath:[...t.basePath,t.definitionPath,a]},!1)??{},i=a===void 0?r?{...s,[t.definitionPath]:r}:s:{$ref:[...t.$refStrategy==="relative"?[]:t.basePath,t.definitionPath,a].join("/"),[t.definitionPath]:{...r,[a]:s}};return t.target==="jsonSchema7"?i.$schema="http://json-schema.org/draft-07/schema#":t.target==="jsonSchema2019-09"&&(i.$schema="https://json-schema.org/draft/2019-09/schema#"),i};function co(n){return kn(n.data)?{type:"runnable",data:{id:n.data.lc_id,name:n.data.getName()}}:{type:"schema",data:{...uo(n.data.schema),title:n.data.name}}}class An{constructor(){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]})}toJSON(){const e={};return Object.values(this.nodes).forEach((t,r)=>{e[t.id]=jr(t.id)?r:t.id}),{nodes:Object.values(this.nodes).map(t=>({id:e[t.id],...co(t)})),edges:this.edges.map(t=>t.data?{source:e[t.source],target:e[t.target],data:t.data}:{source:e[t.source],target:e[t.target]})}}addNode(e,t){if(t!==void 0&&this.nodes[t]!==void 0)throw new Error(`Node with id ${t} already exists`);const r=t||ie(),a={id:r,data:e};return this.nodes[r]=a,a}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter(t=>t.source!==e.id&&t.target!==e.id)}addEdge(e,t,r){if(this.nodes[e.id]===void 0)throw new Error(`Source node ${e.id} not in graph`);if(this.nodes[t.id]===void 0)throw new Error(`Target node ${t.id} not in graph`);const a={source:e.id,target:t.id,data:r};return this.edges.push(a),a}firstNode(){const e=new Set(this.edges.map(r=>r.target)),t=[];return Object.values(this.nodes).forEach(r=>{e.has(r.id)||t.push(r)}),t[0]}lastNode(){const e=new Set(this.edges.map(r=>r.source)),t=[];return Object.values(this.nodes).forEach(r=>{e.has(r.id)||t.push(r)}),t[0]}extend(e){Object.entries(e.nodes).forEach(([t,r])=>{this.nodes[t]=r}),this.edges=[...this.edges,...e.edges]}trimFirstNode(){const e=this.firstNode();if(e){const t=this.edges.filter(r=>r.source===e.id);(Object.keys(this.nodes).length===1||t.length===1)&&this.removeNode(e)}}trimLastNode(){const e=this.lastNode();if(e){const t=this.edges.filter(r=>r.target===e.id);(Object.keys(this.nodes).length===1||t.length===1)&&this.removeNode(e)}}}function Z(n,e){return n&&!Array.isArray(n)&&!(n instanceof Date)&&typeof n=="object"?n:{[e]:n}}class G extends Ee{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){const t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new Ve({bound:this,kwargs:e,config:{}})}map(){return new Bt({bound:this})}withRetry(e){return new lo({bound:this,kwargs:{},config:{},maxAttemptNumber:e==null?void 0:e.stopAfterAttempt,...e})}withConfig(e){return new Ve({bound:this,config:e,kwargs:{}})}withFallbacks(e){return new ho({runnable:this,fallbacks:e.fallbacks})}_getOptionsList(e,t=0){if(Array.isArray(e)){if(e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);return e.map(J)}return Array.from({length:t},()=>J(e))}async batch(e,t,r){var u;const a=this._getOptionsList(t??{},e.length),s=((u=a[0])==null?void 0:u.maxConcurrency)??(r==null?void 0:r.maxConcurrency),i=new ur({maxConcurrency:s,onFailedAttempt:c=>{throw c}}),o=e.map((c,l)=>i.call(async()=>{try{return await this.invoke(c,a[l])}catch(d){if(r!=null&&r.returnExceptions)return d;throw d}}));return Promise.all(o)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){const r=new He(this._streamIterator(e,J(t)));return await r.setup,le.fromAsyncGenerator(r)}_separateRunnableConfigFromCallOptions(e={}){const t=J({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency}),r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,delete r.recursionLimit,delete r.maxConcurrency,[t,r]}async _callWithConfig(e,t,r){const a=J(r),s=await Re(a),i=await(s==null?void 0:s.handleChainStart(this.toJSON(),Z(t,"input"),void 0,a==null?void 0:a.runType,void 0,void 0,(a==null?void 0:a.runName)??this.getName()));let o;try{o=await e.call(this,t,a,i)}catch(u){throw await(i==null?void 0:i.handleChainError(u)),u}return await(i==null?void 0:i.handleChainEnd(Z(o,"output"))),o}async _batchWithConfig(e,t,r,a){const s=this._getOptionsList(r??{},t.length),i=await Promise.all(s.map(Re)),o=await Promise.all(i.map((c,l)=>c==null?void 0:c.handleChainStart(this.toJSON(),Z(t[l],"input"),void 0,s[l].runType,void 0,void 0,s[l].runName??this.getName())));let u;try{u=await e.call(this,t,s,o,a)}catch(c){throw await Promise.all(o.map(l=>l==null?void 0:l.handleChainError(c))),c}return await Promise.all(o.map(c=>c==null?void 0:c.handleChainEnd(Z(u,"output")))),u}async*_transformStreamWithConfig(e,t,r){let a,s=!0,i,o=!0;const u=J(r),c=await Re(u);async function*l(){for await(const h of e){if(s)if(a===void 0)a=h;else try{a=ze(a,h)}catch{a=void 0,s=!1}yield h}}let d;try{const h=await _i(t.bind(this),l(),async()=>c==null?void 0:c.handleChainStart(this.toJSON(),{input:""},void 0,u==null?void 0:u.runType,void 0,void 0,(u==null?void 0:u.runName)??this.getName()),u);d=h.setup;const f=_=>_.name==="log_stream_tracer",y=d==null?void 0:d.handlers.find(f);let w=h.output;y!==void 0&&d!==void 0&&(w=await y.tapOutputIterable(d.runId,h.output));for await(const _ of w)if(yield _,o)if(i===void 0)i=_;else try{i=ze(i,_)}catch{i=void 0,o=!1}}catch(h){throw await(d==null?void 0:d.handleChainError(h,void 0,void 0,void 0,{inputs:Z(a,"input")})),h}await(d==null?void 0:d.handleChainEnd(i??{},void 0,void 0,void 0,{inputs:Z(a,"input")}))}getGraph(e){const t=new An,r=t.addNode({name:`${this.getName()}Input`,schema:mn.any()}),a=t.addNode(this),s=t.addNode({name:`${this.getName()}Output`,schema:mn.any()});return t.addEdge(r,a),t.addEdge(a,s),t}pipe(e){return new Ge({first:this,last:je(e)})}pick(e){return this.pipe(new po(e))}assign(e){return this.pipe(new fo(new pt({steps:e})))}async*transform(e,t){let r;for await(const a of e)r===void 0?r=a:r=ze(r,a);yield*this._streamIterator(r,J(t))}async*streamLog(e,t,r){const a=new vn({...r,autoClose:!1,_schemaFormat:"original"}),s=J(t);yield*this._streamLog(e,a,s)}async*_streamLog(e,t,r){const{callbacks:a}=r;if(a===void 0)r.callbacks=[t];else if(Array.isArray(a))r.callbacks=a.concat([t]);else{const u=a.copy();u.inheritableHandlers.push(t),r.callbacks=u}const s=this.stream(e,r);async function i(){try{const u=await s;for await(const c of u){const l=new Te({ops:[{op:"add",path:"/streamed_output/-",value:c}]});await t.writer.write(l)}}finally{await t.writer.close()}}const o=i();try{for await(const u of t)yield u}finally{await o}}async*streamEvents(e,t,r){if(t.version!=="v1")throw new Error('Only version "v1" of the events schema is currently supported.');let a,s=!1;const i=J(t),o=i.tags??[],u=i.metadata??{},c=i.runName??this.getName(),l=new vn({...r,autoClose:!1,_schemaFormat:"streaming_events"}),d=new Ti({...r}),h=this._streamLog(e,l,i);for await(const y of h){if(a?a=a.concat(y):a=ht.fromRunLogPatch(y),a.state===void 0)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!s){s=!0;const I={...a.state},E={run_id:I.id,event:`on_${I.type}_start`,name:c,tags:o,metadata:u,data:{input:e}};d.includeEvent(E,I.type)&&(yield E)}const w=y.ops.filter(I=>I.path.startsWith("/logs/")).map(I=>I.path.split("/")[2]),_=[...new Set(w)];for(const I of _){let E,Q={};const R=a.state.logs[I];if(R.end_time===void 0?R.streamed_output.length>0?E="stream":E="start":E="end",E==="start")R.inputs!==void 0&&(Q.input=R.inputs);else if(E==="end")R.inputs!==void 0&&(Q.input=R.inputs),Q.output=R.final_output;else if(E==="stream"){const Ft=R.streamed_output.length;if(Ft!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${Ft} instead. Encountered in: "${R.name}"`);Q={chunk:R.streamed_output[0]},R.streamed_output=[]}yield{event:`on_${R.type}_${E}`,name:R.name,run_id:R.id,tags:R.tags,metadata:R.metadata,data:Q}}const{state:A}=a;if(A.streamed_output.length>0){const I=A.streamed_output.length;if(I!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${I} instead. Encountered in: "${A.name}"`);const E={chunk:A.streamed_output[0]};A.streamed_output=[];const Q={event:`on_${A.type}_stream`,run_id:A.id,tags:o,metadata:u,name:c,data:E};d.includeEvent(Q,A.type)&&(yield Q)}}const f=a==null?void 0:a.state;if(f!==void 0){const y={event:`on_${f.type}_end`,name:c,run_id:f.id,tags:o,metadata:u,data:{output:f.final_output}};d.includeEvent(y,f.type)&&(yield y)}}static isRunnable(e){return kn(e)}withListeners({onStart:e,onEnd:t,onError:r}){return new Ve({bound:this,config:{},configFactories:[a=>({callbacks:[new xn({config:a,onStart:e,onEnd:t,onError:r})]})]})}}class Ve extends G{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){const t=wn(this.config,...e);return wn(t,...this.configFactories?await Promise.all(this.configFactories.map(async r=>await r(t))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(t,this.kwargs))}async batch(e,t,r){const a=Array.isArray(t)?await Promise.all(t.map(async s=>this._mergeConfig(s,this.kwargs))):await this._mergeConfig(t,this.kwargs);return this.bound.batch(e,a,r)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(t,this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(t,this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(t,this.kwargs))}async*streamEvents(e,t,r){yield*this.bound.streamEvents(e,{...await this._mergeConfig(t,this.kwargs),version:t.version},r)}static isRunnableBinding(e){return e.bound&&G.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:r}){return new Ve({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[a=>({callbacks:[new xn({config:a,onStart:e,onEnd:t,onError:r})]})]})}}class Bt extends G{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new Bt({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _invoke(e,t,r){return this.bound.batch(e,V(t,{callbacks:r==null?void 0:r.getChild()}))}withListeners({onStart:e,onEnd:t,onError:r}){return new Bt({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:r})})}}class lo extends Ve{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,r){const a=e>1?`retry:attempt:${e}`:void 0;return V(t,{callbacks:r==null?void 0:r.getChild(a)})}async _invoke(e,t,r){return vt(a=>super.invoke(e,this._patchConfigForRetry(a,t,r)),{onFailedAttempt:this.onFailedAttempt,retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _batch(e,t,r,a){const s={};try{await vt(async i=>{const o=e.map((h,f)=>f).filter(h=>s[h.toString()]===void 0||s[h.toString()]instanceof Error),u=o.map(h=>e[h]),c=o.map(h=>this._patchConfigForRetry(i,t==null?void 0:t[h],r==null?void 0:r[h])),l=await super.batch(u,c,{...a,returnExceptions:!0});let d;for(let h=0;h<l.length;h+=1){const f=l[h],y=o[h];f instanceof Error&&d===void 0&&(d=f),s[y.toString()]=f}if(d)throw d;return l},{onFailedAttempt:this.onFailedAttempt,retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(i){if((a==null?void 0:a.returnExceptions)!==!0)throw i}return Object.keys(s).sort((i,o)=>parseInt(i,10)-parseInt(o,10)).map(i=>s[parseInt(i,10)])}async batch(e,t,r){return this._batchWithConfig(this._batch.bind(this),e,t,r)}}class Ge extends G{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){const r=J(t),a=await Re(r),s=await(a==null?void 0:a.handleChainStart(this.toJSON(),Z(e,"input"),void 0,void 0,void 0,void 0,r==null?void 0:r.runName));let i=e,o;try{const u=[this.first,...this.middle];for(let c=0;c<u.length;c+=1)i=await u[c].invoke(i,V(r,{callbacks:s==null?void 0:s.getChild(`seq:step:${c+1}`)}));o=await this.last.invoke(i,V(r,{callbacks:s==null?void 0:s.getChild(`seq:step:${this.steps.length}`)}))}catch(u){throw await(s==null?void 0:s.handleChainError(u)),u}return await(s==null?void 0:s.handleChainEnd(Z(o,"output"))),o}async batch(e,t,r){const a=this._getOptionsList(t??{},e.length),s=await Promise.all(a.map(Re)),i=await Promise.all(s.map((u,c)=>u==null?void 0:u.handleChainStart(this.toJSON(),Z(e[c],"input"),void 0,void 0,void 0,void 0,a[c].runName)));let o=e;try{for(let u=0;u<this.steps.length;u+=1)o=await this.steps[u].batch(o,i.map((l,d)=>{const h=l==null?void 0:l.getChild(`seq:step:${u+1}`);return V(a[d],{callbacks:h})}),r)}catch(u){throw await Promise.all(i.map(c=>c==null?void 0:c.handleChainError(u))),u}return await Promise.all(i.map(u=>u==null?void 0:u.handleChainEnd(Z(o,"output")))),o}async*_streamIterator(e,t){const r=await Re(t),a=await(r==null?void 0:r.handleChainStart(this.toJSON(),Z(e,"input"),void 0,void 0,void 0,void 0,t==null?void 0:t.runName)),s=[this.first,...this.middle,this.last];let i=!0,o;async function*u(){yield e}try{let c=s[0].transform(u(),V(t,{callbacks:a==null?void 0:a.getChild("seq:step:1")}));for(let l=1;l<s.length;l+=1)c=await s[l].transform(c,V(t,{callbacks:a==null?void 0:a.getChild(`seq:step:${l+1}`)}));for await(const l of c)if(yield l,i)if(o===void 0)o=l;else try{o=ze(o,l)}catch{o=void 0,i=!1}}catch(c){throw await(a==null?void 0:a.handleChainError(c)),c}await(a==null?void 0:a.handleChainEnd(Z(o,"output")))}getGraph(e){const t=new An;let r=null;return this.steps.forEach((a,s)=>{const i=a.getGraph(e);s!==0&&i.trimFirstNode(),s!==this.steps.length-1&&i.trimLastNode(),t.extend(i);const o=i.firstNode();if(!o)throw new Error(`Runnable ${a} has no first node`);r&&t.addEdge(r,o),r=i.lastNode()}),t}pipe(e){return Ge.isRunnableSequence(e)?new Ge({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new Ge({first:this.first,middle:[...this.middle,this.last],last:je(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&G.isRunnable(e)}static from([e,...t],r){return new Ge({first:je(e),middle:t.slice(0,-1).map(je),last:je(t[t.length-1]),name:r})}}class pt extends G{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(const[t,r]of Object.entries(e.steps))this.steps[t]=je(r)}static from(e){return new pt({steps:e})}async invoke(e,t){const r=J(t),a=await Re(r),s=await(a==null?void 0:a.handleChainStart(this.toJSON(),{input:e},void 0,void 0,void 0,void 0,r==null?void 0:r.runName)),i={};try{await Promise.all(Object.entries(this.steps).map(async([o,u])=>{i[o]=await u.invoke(e,V(r,{callbacks:s==null?void 0:s.getChild(`map:key:${o}`)}))}))}catch(o){throw await(s==null?void 0:s.handleChainError(o)),o}return await(s==null?void 0:s.handleChainEnd(i)),i}async*_transform(e,t,r){const a={...this.steps},s=gn(e,Object.keys(a).length),i=new Map(Object.entries(a).map(([o,u],c)=>{const l=u.transform(s[c],V(r,{callbacks:t==null?void 0:t.getChild(`map:key:${o}`)}));return[o,l.next().then(d=>({key:o,gen:l,result:d}))]}));for(;i.size;){const{key:o,result:u,gen:c}=await Promise.race(i.values());i.delete(o),u.done||(yield{[o]:u.value},i.set(o,c.next().then(l=>({key:o,gen:c,result:l}))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const a=new He(this.transform(r(),t));return await a.setup,le.fromAsyncGenerator(a)}}class xr extends G{static lc_name(){return"RunnableLambda"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.func=e.func}static from(e){return new xr({func:e})}async _invoke(e,t,r){return new Promise((a,s)=>{const i=V(t,{callbacks:r==null?void 0:r.getChild(),recursionLimit:((t==null?void 0:t.recursionLimit)??wr)-1});vr.getInstance().run(i,async()=>{try{let o=await this.func(e,{...i,config:i});if(o&&G.isRunnable(o)){if((t==null?void 0:t.recursionLimit)===0)throw new Error("Recursion limit reached.");o=await o.invoke(e,{...i,recursionLimit:(i.recursionLimit??wr)-1})}a(o)}catch(o){s(o)}})})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async*_transform(e,t,r){let a;for await(const i of e)if(a===void 0)a=i;else try{a=ze(a,i)}catch{a=i}const s=await new Promise((i,o)=>{vr.getInstance().run(r,async()=>{try{const u=await this.func(a,{...r,config:r});i(u)}catch(u){o(u)}})});if(s&&G.isRunnable(s)){if((r==null?void 0:r.recursionLimit)===0)throw new Error("Recursion limit reached.");const i=await s.stream(a,V(r,{callbacks:t==null?void 0:t.getChild(),recursionLimit:((r==null?void 0:r.recursionLimit)??wr)-1}));for await(const o of i)yield o}else yield s}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const a=new He(this.transform(r(),t));return await a.setup,le.fromAsyncGenerator(a)}}class ho extends G{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,t){const r=await H.configure(t==null?void 0:t.callbacks,void 0,t==null?void 0:t.tags,void 0,t==null?void 0:t.metadata),a=await(r==null?void 0:r.handleChainStart(this.toJSON(),Z(e,"input"),void 0,void 0,void 0,void 0,t==null?void 0:t.runName));let s;for(const i of this.runnables())try{const o=await i.invoke(e,V(t,{callbacks:a==null?void 0:a.getChild()}));return await(a==null?void 0:a.handleChainEnd(Z(o,"output"))),o}catch(o){s===void 0&&(s=o)}throw s===void 0?new Error("No error stored at end of fallback."):(await(a==null?void 0:a.handleChainError(s)),s)}async batch(e,t,r){if(r!=null&&r.returnExceptions)throw new Error("Not implemented.");const a=this._getOptionsList(t??{},e.length),s=await Promise.all(a.map(u=>H.configure(u==null?void 0:u.callbacks,void 0,u==null?void 0:u.tags,void 0,u==null?void 0:u.metadata))),i=await Promise.all(s.map((u,c)=>u==null?void 0:u.handleChainStart(this.toJSON(),Z(e[c],"input"),void 0,void 0,void 0,void 0,a[c].runName)));let o;for(const u of this.runnables())try{const c=await u.batch(e,i.map((l,d)=>V(a[d],{callbacks:l==null?void 0:l.getChild()})),r);return await Promise.all(i.map((l,d)=>l==null?void 0:l.handleChainEnd(Z(c[d],"output")))),c}catch(c){o===void 0&&(o=c)}throw o?(await Promise.all(i.map(u=>u==null?void 0:u.handleChainError(o))),o):new Error("No error stored at end of fallbacks.")}}function je(n){if(typeof n=="function")return new xr({func:n});if(G.isRunnable(n))return n;if(!Array.isArray(n)&&typeof n=="object"){const e={};for(const[t,r]of Object.entries(n))e[t]=je(r);return new pt({steps:e})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}class fo extends G{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof pt&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){const r=await this.mapper.invoke(e,t);return{...e,...r}}async*_transform(e,t,r){const a=this.mapper.getStepsKeys(),[s,i]=gn(e),o=this.mapper.transform(i,V(r,{callbacks:t==null?void 0:t.getChild()})),u=o.next();for await(const c of s){if(typeof c!="object"||Array.isArray(c))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof c}`);const l=Object.fromEntries(Object.entries(c).filter(([d])=>!a.includes(d)));Object.keys(l).length>0&&(yield l)}yield(await u).value;for await(const c of o)yield c}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const a=new He(this.transform(r(),t));return await a.setup,le.fromAsyncGenerator(a)}}class po extends G{static lc_name(){return"RunnablePick"}constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{const t=this.keys.map(r=>[r,e[r]]).filter(r=>r[1]!==void 0);return t.length===0?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(const t of e){const r=await this._pick(t);r!==void 0&&(yield r)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const a=new He(this.transform(r(),t));return await a.setup,le.fromAsyncGenerator(a)}}const mo=n=>n.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":n.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":n.startsWith("gpt-4-32k")?"gpt-4-32k":n.startsWith("gpt-4-")?"gpt-4":n,yo=()=>!1;class go extends G{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??yo(),this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}}class bo extends go{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...r}){super({callbacks:e??t,...r}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof r.cache=="object"?this.cache=r.cache:r.cache?this.cache=or.global():this.cache=void 0,this.caller=new ur(r??{})}async getNumTokens(e){if(typeof e!="string")return 0;let t=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await bs("modelName"in this?mo(this.modelName):"gpt2")}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}if(this._encoding)try{t=this._encoding.encode(e).length}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}return t}static _convertInputToPromptValue(e){return typeof e=="string"?new Qa(e):Array.isArray(e)?new Ya(e.map(zn)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall(e){const t={...this._identifyingParams(),...e,_type:this._llmType(),_model:this._modelType()};return Object.entries(t).filter(([s,i])=>i!==void 0).map(([s,i])=>`${s}:${JSON.stringify(i)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}}class mt extends bo{constructor({concurrency:e,...t}){super(e?{maxConcurrency:e,...t}:t),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","llms",this._llmType()]})}async invoke(e,t){const r=mt._convertInputToPromptValue(e);return(await this.generatePrompt([r],t,t==null?void 0:t.callbacks)).generations[0][0].text}async*_streamResponseChunks(e,t,r){throw new Error("Not implemented.")}_separateRunnableConfigFromCallOptions(e){const[t,r]=super._separateRunnableConfigFromCallOptions(e);return r!=null&&r.timeout&&!r.signal&&(r.signal=AbortSignal.timeout(r.timeout)),[t,r]}async*_streamIterator(e,t){if(this._streamResponseChunks===mt.prototype._streamResponseChunks)yield this.invoke(e,t);else{const r=mt._convertInputToPromptValue(e),[a,s]=this._separateRunnableConfigFromCallOptions(t),i=await H.configure(a.callbacks,this.callbacks,a.tags,this.tags,a.metadata,this.metadata,{verbose:this.verbose}),o={options:s,invocation_params:this==null?void 0:this.invocationParams(s),batch_size:1},u=await(i==null?void 0:i.handleLLMStart(this.toJSON(),[r.toString()],void 0,void 0,o,void 0,void 0,a.runName));let c=new q({text:""});try{for await(const l of this._streamResponseChunks(e.toString(),s,u==null?void 0:u[0]))c?c=c.concat(l):c=l,typeof l.text=="string"&&(yield l.text)}catch(l){throw await Promise.all((u??[]).map(d=>d==null?void 0:d.handleLLMError(l))),l}await Promise.all((u??[]).map(l=>l==null?void 0:l.handleLLMEnd({generations:[[c]]})))}}async generatePrompt(e,t,r){const a=e.map(s=>s.toString());return this.generate(a,t,r)}invocationParams(e){return{}}_flattenLLMResult(e){const t=[];for(let r=0;r<e.generations.length;r+=1){const a=e.generations[r];if(r===0)t.push({generations:[a],llmOutput:e.llmOutput});else{const s=e.llmOutput?{...e.llmOutput,tokenUsage:{}}:void 0;t.push({generations:[a],llmOutput:s})}}return t}async _generateUncached(e,t,r){const a=await H.configure(r.callbacks,this.callbacks,r.tags,this.tags,r.metadata,this.metadata,{verbose:this.verbose}),s={options:t,invocation_params:this==null?void 0:this.invocationParams(t),batch_size:e.length},i=await(a==null?void 0:a.handleLLMStart(this.toJSON(),e,void 0,void 0,s,void 0,void 0,r==null?void 0:r.runName));let o;try{o=await this._generate(e,t,i==null?void 0:i[0])}catch(l){throw await Promise.all((i??[]).map(d=>d==null?void 0:d.handleLLMError(l))),l}const u=this._flattenLLMResult(o);await Promise.all((i??[]).map((l,d)=>l==null?void 0:l.handleLLMEnd(u[d])));const c=(i==null?void 0:i.map(l=>l.runId))||void 0;return Object.defineProperty(o,ge,{value:c?{runIds:c}:void 0,configurable:!0}),o}async _generateCached({prompts:e,cache:t,llmStringKey:r,parsedOptions:a,handledOptions:s}){const i=await H.configure(s.callbacks,this.callbacks,s.tags,this.tags,s.metadata,this.metadata,{verbose:this.verbose}),o={options:a,invocation_params:this==null?void 0:this.invocationParams(a),batch_size:e.length,cached:!0},u=await(i==null?void 0:i.handleLLMStart(this.toJSON(),e,void 0,void 0,o,void 0,void 0,s==null?void 0:s.runName)),c=[],d=(await Promise.allSettled(e.map(async(y,w)=>{const _=await t.lookup(y,r);return _==null&&c.push(w),_}))).map((y,w)=>({result:y,runManager:u==null?void 0:u[w]})).filter(({result:y})=>y.status==="fulfilled"&&y.value!=null||y.status==="rejected"),h=[];await Promise.all(d.map(async({result:y,runManager:w},_)=>{if(y.status==="fulfilled"){const A=y.value;return h[_]=A,A.length&&await(w==null?void 0:w.handleLLMNewToken(A[0].text)),w==null?void 0:w.handleLLMEnd({generations:[A]})}else return await(w==null?void 0:w.handleLLMError(y.reason)),Promise.reject(y.reason)}));const f={generations:h,missingPromptIndices:c};return Object.defineProperty(f,ge,{value:u?{runIds:u==null?void 0:u.map(y=>y.runId)}:void 0,configurable:!0}),f}async generate(e,t,r){if(!Array.isArray(e))throw new Error("Argument 'prompts' is expected to be a string[]");let a;Array.isArray(t)?a={stop:t}:a=t;const[s,i]=this._separateRunnableConfigFromCallOptions(a);if(s.callbacks=s.callbacks??r,!this.cache)return this._generateUncached(e,i,s);const{cache:o}=this,u=this._getSerializedCacheKeyParametersForCall(i),{generations:c,missingPromptIndices:l}=await this._generateCached({prompts:e,cache:o,llmStringKey:u,parsedOptions:i,handledOptions:s});let d={};if(l.length>0){const h=await this._generateUncached(l.map(f=>e[f]),i,s);await Promise.all(h.generations.map(async(f,y)=>{const w=l[y];return c[w]=f,o.update(e[w],u,f)})),d=h.llmOutput??{}}return{generations:c,llmOutput:d}}async call(e,t,r){const{generations:a}=await this.generate([e],t,r);return a[0][0].text}async predict(e,t,r){return this.call(e,t,r)}async predictMessages(e,t,r){const a=Wt(e),s=await this.call(a,t,r);return new Nr(s)}_identifyingParams(){return{}}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}_modelType(){return"base_llm"}}class _o extends mt{async _generate(e,t,r){return{generations:await Promise.all(e.map((s,i)=>this._call(s,{...t,promptIndex:i},r).then(o=>[{text:o}])))}}}async function*vo(n,e,t){let r=n;r.startsWith("http://localhost:")&&(r=r.replace("http://localhost:","http://127.0.0.1:"));const a=await fetch(r,{method:"POST",body:JSON.stringify(e),headers:{"Content-Type":"application/json",...t.headers},signal:t.signal});if(!a.ok){let u;const c=await a.text();try{const l=JSON.parse(c);u=new Error(`Ollama call failed with status code ${a.status}: ${l.error}`)}catch{u=new Error(`Ollama call failed with status code ${a.status}: ${c}`)}throw u.response=a,u}if(!a.body)throw new Error("Could not begin Ollama stream. Please check the given URL and try again.");const s=le.fromReadableStream(a.body),i=new TextDecoder;let o="";for await(const u of s){const l=(o+i.decode(u)).split(`
`);o=l.pop()||"";for(const d of l)try{yield JSON.parse(d)}catch{console.warn(`Received a non-JSON parseable chunk: ${d}`)}}}async function*wo(n,e,t){yield*vo(`${n}/api/generate`,e,t)}class xo extends _o{static lc_name(){return"Ollama"}constructor(e){var t;super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"llama2"}),Object.defineProperty(this,"baseUrl",{enumerable:!0,configurable:!0,writable:!0,value:"http://localhost:11434"}),Object.defineProperty(this,"keepAlive",{enumerable:!0,configurable:!0,writable:!0,value:"5m"}),Object.defineProperty(this,"embeddingOnly",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"f16KV",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"headers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logitsAll",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lowVram",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mainGpu",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mirostat",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mirostatEta",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mirostatTau",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numBatch",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numCtx",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numGpu",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numGqa",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numKeep",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numPredict",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numThread",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"penalizeNewline",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"repeatLastN",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"repeatPenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ropeFrequencyBase",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ropeFrequencyScale",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tfsZ",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topK",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"typicalP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"useMLock",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"useMMap",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"vocabOnly",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"format",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.model=e.model??this.model,this.baseUrl=(t=e.baseUrl)!=null&&t.endsWith("/")?e.baseUrl.slice(0,-1):e.baseUrl??this.baseUrl,this.keepAlive=e.keepAlive??this.keepAlive,this.headers=e.headers??this.headers,this.embeddingOnly=e.embeddingOnly,this.f16KV=e.f16KV,this.frequencyPenalty=e.frequencyPenalty,this.logitsAll=e.logitsAll,this.lowVram=e.lowVram,this.mainGpu=e.mainGpu,this.mirostat=e.mirostat,this.mirostatEta=e.mirostatEta,this.mirostatTau=e.mirostatTau,this.numBatch=e.numBatch,this.numCtx=e.numCtx,this.numGpu=e.numGpu,this.numGqa=e.numGqa,this.numKeep=e.numKeep,this.numPredict=e.numPredict,this.numThread=e.numThread,this.penalizeNewline=e.penalizeNewline,this.presencePenalty=e.presencePenalty,this.repeatLastN=e.repeatLastN,this.repeatPenalty=e.repeatPenalty,this.ropeFrequencyBase=e.ropeFrequencyBase,this.ropeFrequencyScale=e.ropeFrequencyScale,this.temperature=e.temperature,this.stop=e.stop,this.tfsZ=e.tfsZ,this.topK=e.topK,this.topP=e.topP,this.typicalP=e.typicalP,this.useMLock=e.useMLock,this.useMMap=e.useMMap,this.vocabOnly=e.vocabOnly,this.format=e.format}_llmType(){return"ollama"}invocationParams(e){return{model:this.model,format:this.format,keep_alive:this.keepAlive,images:e==null?void 0:e.images,options:{embedding_only:this.embeddingOnly,f16_kv:this.f16KV,frequency_penalty:this.frequencyPenalty,logits_all:this.logitsAll,low_vram:this.lowVram,main_gpu:this.mainGpu,mirostat:this.mirostat,mirostat_eta:this.mirostatEta,mirostat_tau:this.mirostatTau,num_batch:this.numBatch,num_ctx:this.numCtx,num_gpu:this.numGpu,num_gqa:this.numGqa,num_keep:this.numKeep,num_predict:this.numPredict,num_thread:this.numThread,penalize_newline:this.penalizeNewline,presence_penalty:this.presencePenalty,repeat_last_n:this.repeatLastN,repeat_penalty:this.repeatPenalty,rope_frequency_base:this.ropeFrequencyBase,rope_frequency_scale:this.ropeFrequencyScale,temperature:this.temperature,stop:(e==null?void 0:e.stop)??this.stop,tfs_z:this.tfsZ,top_k:this.topK,top_p:this.topP,typical_p:this.typicalP,use_mlock:this.useMLock,use_mmap:this.useMMap,vocab_only:this.vocabOnly}}}async*_streamResponseChunks(e,t,r){const a=await this.caller.call(async()=>wo(this.baseUrl,{...this.invocationParams(t),prompt:e},{...t,headers:this.headers}));for await(const s of a)s.done?yield new q({text:"",generationInfo:{model:s.model,total_duration:s.total_duration,load_duration:s.load_duration,prompt_eval_count:s.prompt_eval_count,prompt_eval_duration:s.prompt_eval_duration,eval_count:s.eval_count,eval_duration:s.eval_duration}}):(yield new q({text:s.response,generationInfo:{...s,response:void 0}}),await(r==null?void 0:r.handleLLMNewToken(s.response??"")))}async _call(e,t,r){const a=[];for await(const s of this._streamResponseChunks(e,t,r))a.push(s.text);return a.join("")}}self.addEventListener("message",async n=>{const{baseUrl:e,model:t,question:r,history:a,phoneList:s,computerList:i}=n.data;await(async()=>{const u=new xo({baseUrl:e,model:t}),c=new AbortController;let l;const d=a;console.log(typeof d+" and this is its content: "+JSON.stringify(d));const h=ko(r,d,s,i);try{console.log("Starting stream...");const f=await u.stream(h,{signal:c.signal}),y=[];l=setTimeout(()=>{console.log("Timeout reached, aborting stream..."),c.abort()},8e3);for await(const E of f){if(c.signal.aborted){console.log("Stream aborted by controller.");break}y.push(E)}const w=y.join("");console.log(w);const _={sender:"AI",content:w,timestamp:new Date().getTime()},A=[...d,_],I={output:w,previousMessages:A};self.postMessage({success:!0,data:I})}catch(f){f.name==="AbortError"?console.log("Fetch aborted by timeout"):(console.error("Error during streaming:",f),self.postMessage({success:!1,error:f.message}))}finally{l&&clearTimeout(l)}})()});function ko(n,e,t,r){const a=["I'd be happy to help","What are you looking for?","The display on this phone is fantastic!","The camera on this phone is not the best. Still usable but not super good.","Have a nice day!"],s=`
    You should give advice and sell phones and latops from the inventory to the user. Llamas response has to follow {rules}. You don't have to roleplay. The users {question} is as bellow, the {phone inventory} and {laptop inventory} is as bellow. The {Chat history} is have conversation has looked so far. If {Chat history} is empty this is the start of the conversation.
    rules:
    - Provide tailored recommendations based on user preferences.
    - Keep responses concise and conversational, under 25 words (IMPORTANT).
    - Avoid lists. Present recommendations as part of a natural conversation (IMPORTANT).
    - If uncertain, prompt for clarification rather than providing generic responses.
    - Offer additional details about recommended phones upon request.
    - You can only recommend products's which are in the inventory (IMPORTANT).
    - You are not to change anything in the chat history whether it be add or remove(IMPORTANT).
    - You are to answer in proffesional manor do not use emoji's or stuff like *smile* (IMPORTANT).
    question: ${n}.
    Chat history: ${JSON.stringify(Oo(e))}.
    exampels: ${To(a)}.
    phone inventory: ${t}.
    laptop inventory: ${r}.
    `;return console.log("THIS IS THE PROMPT(TEST):"+s),s}function To(n){return n.join(`
`)}function Oo(n){return n.map(e=>({sender:e.sender,content:e.content}))}})();
